/* remoteStorage.js 0.7.0-head remoteStoragejs.com, MIT-licensed */

/**
 * almond 0.1.4 Copyright (c) 2011, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

//         remoteStorage.contacts.list().map(function(c) {

/**
 * JSONSchema Validator - Validates JavaScript objects using JSON Schemas
 *	(http://www.json.com/json-schema-proposal/)
 *
 * Copyright (c) 2007 Kris Zyp SitePen (www.sitepen.com)
 * Licensed under the MIT (MIT-LICENSE.txt) license.
To use the validator call the validate function with an instance object and an optional schema object.
If a schema is provided, it will be used to validate. If the instance object refers to a schema (self-validating),
that schema will be used to validate and the schema parameter is not necessary (if both exist,
both validations will occur).
The validate method will return an array of validation errors. If there are no errors, then an
empty list will be returned. A validation error will have two properties:
"property" which indicates which property had the error
"message" which indicates what the error was
 */

/**
 * vCardJS - a vCard 4.0 implementation in JavaScript
 *
 * (c) 2012 - Niklas Cathor
 *
 * Latest source: https://github.com/nilclass/vcardjs
 **/

/*!
    Math.uuid.js (v1.4)
    http://www.broofa.com
    mailto:robert@broofa.com

    Copyright (c) 2010 Robert Kieffer
    Dual licensed under the MIT and GPL licenses.
  */

(function(){var requirejs,require,define;(function(undef){function normalize(name,baseName){var nameParts,nameSegment,mapValue,foundMap,foundI,foundStarMap,starI,i,j,part,baseParts=baseName&&baseName.split("/"),map=config.map,starMap=map&&map["*"]||{};if(name&&name.charAt(0)==="."&&baseName){baseParts=baseParts.slice(0,baseParts.length-1),name=baseParts.concat(name.split("/"));for(i=0;i<name.length;i+=1){part=name[i];if(part===".")name.splice(i,1),i-=1;else if(part===".."){if(i===1&&(name[2]===".."||name[0]===".."))break;i>0&&(name.splice(i-1,2),i-=2)}}name=name.join("/")}if((baseParts||starMap)&&map){nameParts=name.split("/");for(i=nameParts.length;i>0;i-=1){nameSegment=nameParts.slice(0,i).join("/");if(baseParts)for(j=baseParts.length;j>0;j-=1){mapValue=map[baseParts.slice(0,j).join("/")];if(mapValue){mapValue=mapValue[nameSegment];if(mapValue){foundMap=mapValue,foundI=i;break}}}if(foundMap)break;!foundStarMap&&starMap&&starMap[nameSegment]&&(foundStarMap=starMap[nameSegment],starI=i)}!foundMap&&foundStarMap&&(foundMap=foundStarMap,foundI=starI),foundMap&&(nameParts.splice(0,foundI,foundMap),name=nameParts.join("/"))}return name}function makeRequire(relName,forceSync){return function(){return req.apply(undef,aps.call(arguments,0).concat([relName,forceSync]))}}function makeNormalize(relName){return function(name){return normalize(name,relName)}}function makeLoad(depName){return function(value){defined[depName]=value}}function callDep(name){if(waiting.hasOwnProperty(name)){var args=waiting[name];delete waiting[name],defining[name]=!0,main.apply(undef,args)}if(!defined.hasOwnProperty(name))throw new Error("No "+name);return defined[name]}function makeMap(name,relName){var prefix,plugin,index=name.indexOf("!");return index!==-1?(prefix=normalize(name.slice(0,index),relName),name=name.slice(index+1),plugin=callDep(prefix),plugin&&plugin.normalize?name=plugin.normalize(name,makeNormalize(relName)):name=normalize(name,relName)):name=normalize(name,relName),{f:prefix?prefix+"!"+name:name,n:name,p:plugin}}function makeConfig(name){return function(){return config&&config.config&&config.config[name]||{}}}var main,req,defined={},waiting={},config={},defining={},aps=[].slice;main=function(name,deps,callback,relName){var cjsModule,depName,ret,map,i,args=[],usingExports;relName=relName||name;if(typeof callback=="function"){deps=!deps.length&&callback.length?["require","exports","module"]:deps;for(i=0;i<deps.length;i+=1){map=makeMap(deps[i],relName),depName=map.f;if(depName==="require")args[i]=makeRequire(name);else if(depName==="exports")args[i]=defined[name]={},usingExports=!0;else if(depName==="module")cjsModule=args[i]={id:name,uri:"",exports:defined[name],config:makeConfig(name)};else if(defined.hasOwnProperty(depName)||waiting.hasOwnProperty(depName))args[i]=callDep(depName);else if(map.p)map.p.load(map.n,makeRequire(relName,!0),makeLoad(depName),{}),args[i]=defined[depName];else if(!defining[depName])throw new Error(name+" missing "+depName)}ret=callback.apply(defined[name],args);if(name)if(cjsModule&&cjsModule.exports!==undef&&cjsModule.exports!==defined[name])defined[name]=cjsModule.exports;else if(ret!==undef||!usingExports)defined[name]=ret}else name&&(defined[name]=callback)},requirejs=require=req=function(deps,callback,relName,forceSync,alt){return typeof deps=="string"?callDep(makeMap(deps,callback).f):(deps.splice||(config=deps,callback.splice?(deps=callback,callback=relName,relName=null):deps=undef),callback=callback||function(){},typeof relName=="function"&&(relName=forceSync,forceSync=alt),forceSync?main(undef,deps,callback,relName):setTimeout(function(){main(undef,deps,callback,relName)},15),req)},req.config=function(cfg){return config=cfg,req},define=function(name,deps,callback){deps.splice||(callback=deps,deps=[]),waiting[name]=[name,deps,callback]},define.amd={jQuery:!0}})(),define("../build/lib/almond",function(){}),define("lib/assets",[],function(){return{remoteStorageIcon:"data:image/png;base64,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",remoteStorageCube:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAR2SURBVFiFtddfqGVVHQfwz2/vfZ28c2WgP6hMoYkUV4qIYnSKmaQYwaaJ3oLeUnpJmDCmUhCaIhhKGelhelCqN9+ECKdAxR6kgnJASBN9KTGwP2oKTtyZs8/+9bDXPufcfe51xju6YLHX2fu3ft/v+q7fWb/fisy0o3brez6qmt4Luvo7frvx/E7cxNsmcCj2WGnuEb6JaXlbSz8zaX/ksXzj3SHwg6j8aeU28jjeh8TZ8nU3Aq8Sx+2b/ML3s3vnCHxp5YB0Hz6OTkgpMax2jxBSoMJfhGMemTx5aQQOxzWsnCC/gm6hZ+mvFMv36xUYCJQev2Jyt9P54tsj8OVYNW2+izuxIkzlAoGUQuLlMuNqKcQCgVBJNSa4X93+xK/zfxcmcLj5GtUJ8ipMC/i0gA/PQYF/lFkfHClQFxJ1IVET/6S72+n2oa0JHL7s0+RPsR9tAZuOxuNtGKS9xpL8A7BmNP4j8S2nzz+lGJaWDxB7RyCbV54DkZiSrbAhbJBt/25LtUbEY2+P1bdmQY1V8mr8DruET5Z9n4NHTOmmZK9A2ihzp3RdL3tVy+z16OeG0ElncI48yGzeogIzQgexByelp2fMZ+CDAtFK56XzxFwBXSE6C9incbL4PDha9BKBPrjCddJRVT5DHsMLczkLUGhFbPR9iJNYjJUXyGOqfEY6KlxnHrybVjwm0JVDJmV8FZ8TeZysZdyBK9FKXb/6mdTZ+4uXRXcKUxnHpavKdqV58G5JYJFdLvT3yuok3ROiuY3JZ3Rxu7CH7lxvHlPpNVX+nJU/yMk9VJ8nm5GvMc42W6Bwnhl2KRyQ7cOyaqy1R0ScEvFq6aestUdk1cj2YeEA3RwwtwbfSoHtxxmJXeS3nV25RR0/9KnJL8GZyz7i7MoD5MfQ9LZ5YZ+WY+AiW16vc8if/av8PkRevxNPiwTiLceRISPIM3iUOGxa/wfUbiTvxy3ETb3tRfi0HAMx+xgLY1XIeAUPYoO4S+YNqupyVXW5zBuIu/pvHuxtq5j5DLHkfxsFxoaBlN1vVKbEN2TQ5wdYLc8++YibhZvJx3VZizgy8rVEYhwDfUKZFxd/Jf8m4gsydtENJ17TZ8lcLbOGrFfJrKmOiDxHPk58GJ8oPqu3UmDOLr2B5/AhYt08K9Z9AMdAsCeQml6BnKdiriC+iP/iKWkdH7gQgSRfQoi4SWoLcMqsRaUcZiX1xu4yrZmpp6p721lavlLYK/PfeIm4djsCE7xZDNqSVocV9evNJCKIjq6TuTbbAlWvQGZfiCwWJqkqqb7pMUwG0IV/QXwdz1ouKjZXOP021EQjqt2i2k00/Tv1Evj8OfRnC1aPeokl2e/LrM/aYUk2Pgc43T6knqzjBCZytqqhpGpK0DXCmrC26d1Qgs3BJzihnqyPwbdWYJMaFyzLnyuW6yMFLrEsH7ftLyZ/LxbX7vRisrwFW7VHJk/a1+4njuL1udx5Rd9nW/A6cdS+dv/FgHPpl9PhorH67l9Ox62/nv8YdPX3dno9/z+G+TGrzjgPKwAAAABJRU5ErkJggg==",widgetCss:"#remotestorage-state { position:fixed; top:15px; right:15px; height:32px; width:275px; font:normal 16px/100% sans-serif; z-index:99999; background:rgba(0,0,0,.3); padding:5px; border-radius:7px; box-shadow:0 1px rgba(255,255,255,.05), inset 0 1px rgba(0,0,0,.05); transition:width 500ms, background 500ms; }\n#remotestorage-state.connected, #remotestorage-state.busy, #remotestorage-state.offline { width:32px; background:none; box-shadow:none; }\n.remotestorage-button { margin:0; padding:.3em; font-size:14px; height:26px !important; background:#ddd; color:#333; border:1px solid #ccc; border-radius:3px; box-shadow:0 1px 1px #fff inset; }\n#remotestorage-register-button { position:absolute; left:25px; top:8px; max-height:16px; text-decoration:none; font-weight:normal; }\n#remotestorage-connect-button { position:absolute; right:8px; top:8px; padding:0 0 0 17px; width:90px; cursor:pointer; text-align:left; border-radius:0 3px 3px 0; font-weight:normal; }\n#remotestorage-connect-button:hover, #remotestorage-connect-button:focus, .remotestorage-button:hover, .remotestorage-button:focus { background:#eee; color:#000; text-decoration:none; }\n#remotestorage-useraddress { position:absolute; left:25px; top:8px; margin:0; padding:0 17px 0 3px; height:25px; width:142px; background:#eee; color:#333; border:0; border-radius:3px 0 0 3px; box-shadow:0 1px #fff, inset 0 1px #999; font-weight:normal; font-size:14px;}\n#remotestorage-useraddress:hover, #remotestorage-useraddress:focus { background:#fff; color:#000; }\n#remotestorage-cube { position:absolute; right:84px; -webkit-transition:right 500ms; -moz-transition:right 500ms; transition:right 500ms; z-index:99997; }\n#remotestorage-questionmark { position:absolute; left:0; padding:9px 8px; color:#fff; text-decoration:none; z-index:99999; font-weight:normal; }\n.infotext { position:absolute; left:0; top:0; width:255px; height:32px; padding:6px 5px 4px 25px; font-size:10px; background:black; color:white; border-radius:7px; opacity:.85; text-decoration:none; white-space:nowrap; z-index:99998; }\n#remotestorage-questiomark:hover { color:#fff; }\n#remotestorage-questionmark:hover+#remotestorage-infotext { display:inline; }\n#remotestorage-state.busy #remotestorage-cube, #remotestoreage-state.authing #remotestorage-cube, #remotestorage-state.connecting #remotestorage-cube {   -webkit-animation-name:remotestorage-loading; -webkit-animation-duration:2s; -webkit-animation-iteration-count:infinite; -webkit-animation-timing-function:linear;\n   -moz-animation-name:remotestorage-loading; -moz-animation-duration:2s; -moz-animation-iteration-count:infinite; -moz-animation-timing-function:linear;\n   -o-animation-name:remotestorage-loading; -o-animation-duration:2s; -o-animation-iteration-count:infinite; -o-animation-timing-function:linear;\n   -ms-animation-name:remotestorage-loading; -ms-animation-duration:2s; -ms-animation-iteration-count:infinite; -ms-animation-timing-function:linear; }\n   @-webkit-keyframes remotestorage-loading { from{-webkit-transform:rotate(0deg)} to{-webkit-transform:rotate(360deg)} }\n   @-moz-keyframes remotestorage-loading { from{-moz-transform:rotate(0deg)} to{-moz-transform:rotate(360deg)} }\n   @-o-keyframes remotestorage-loading { from{-o-transform:rotate(0deg)} to{-o-transform:rotate(360deg)} }\n   @-ms-keyframes remotestorage-loading { from{-ms-transform:rotate(0deg)} to{ -ms-transform:rotate(360deg)} }\n#remotestorage-connect-button, #remotestorage-questionmark, #remotestorage-register-button, #remotestorage-cube, #remotestorage-useraddress, #remotestorage-infotext, #remotestorage-devsonly, #remotestorage-bubble { display:none }\n#remotestorage-state.anonymous #remotestorage-cube, #remotestorage-state.anonymous #remotestorage-connect-button, #remotestorage-state.anonymous #remotestorage-register-button, #remotestorage-state.anonymous #remotestorage-questionmark { display: block }\n#remotestorage-state.connecting #remotestorage-cube, #remotestorage-state.connecting #remotestorage-connect-button, #remotestorage-state.connecting #remotestorage-useraddress, #remotestorage-state.connecting #remotestorage-questionmark { display: block }\n#remotestorage-state.interrupted #remotestorage-cube, #remotestorage-state.interrupted #remotestorage-connect-button, #remotestorage-state.interrupted #remotestorage-register-button, #remotestorage-state.interrupted #remotestorage-questionmark { display: block }\n#remotestorage-state.failed #remotestorage-cube, #remotestorage-state.failed #remotestorage-connect-button, #remotestorage-state.failed #remotestorage-register-button, #remotestorage-state.failed #remotestorage-questionmark { display: block }\n#remotestorage-state.authing #remotestorage-cube, #remotestorage-state.authing #remotestorage-connect-button, #remotestorage-state.authing #remotestorage-useraddress, #remotestorage-state.authing #remotestorage-questionmark { display: block }\n#remotestorage-state.typing #remotestorage-cube, #remotestorage-state.typing #remotestorage-connect-button, #remotestorage-state.typing #remotestorage-useraddress, #remotestorage-state.typing #remotestorage-questionmark { display: block }\n#remotestorage-state.connected #remotestorage-cube, #remotestorage-state.busy #remotestorage-cube, #remotestorage-state.offline #remotestorage-cube { right:0; opacity:.5; cursor:pointer; display: block }\n#remotestorage-state.devsonly #remotestorage-devsonly { display: block }\n#remotestorage-bubble { position:absolute; right:6px; top:9px; padding:5px 28px 2px 6px; height:17px; white-space:nowrap; font-size:10px; background:#000; color:#fff; border-radius:5px; opacity:.5; text-decoration:none; z-index:99996; }\n#remotestorage-state.connected #remotestorage-bubble, #remotestorage-state.busy #remotestorage-bubble, #remotestorage-state.offline #remotestorage-bubble { cursor:pointer; }\n#remotestorage-bubble strong { font-weight:bold; }\n#remotestorage-state.connected #remotestorage-cube:hover, #remotestorage-state.busy #remotestorage-cube:hover, #remotestorage-state.offline #remotestorage-cube:hover { opacity:1; }\n#remotestorage-state.connected #remotestorage-bubble:hover, #remotestorage-state.busy #remotestorage-bubble:hover, #remotestorage-state.offline #remotestorage-bubble:hover { display:inline; }\n#remotestorage-state.connected #remotestorage-cube:hover+#remotestorage-bubble, #remotestorage-state.busy #remotestorage-cube:hover+#remotestorage-bubble, #remotestorage-state.offline #remotestorage-cube:hover+#remotestorage-bubble { display:inline; }\n"}}),define("lib/util",[],function(){var loggers={},silentLogger={},knownLoggers=["base","sync","webfinger","getputdelete","platform","baseClient","widget","store","foreignClient"],logFn=null,util={toArray:function(arrayLike){return Array.prototype.slice.call(arrayLike)},isDir:function(path){return path.substr(-1)=="/"},pathParts:function(path){var parts=["/"],md;while(md=path.match(/^(.*?)([^\/]+\/?)$/))parts.unshift(md[2]),path=md[1];return parts},extend:function(a,b){for(var key in b)a[key]=b[key];return a},containingDir:function(path){var dir=path.replace(/[^\/]+\/?$/,"");return dir==path?null:dir},baseName:function(path){var parts=path.split("/");return util.isDir(path)?parts[parts.length-2]+"/":parts[parts.length-1]},bindAll:function(object){for(var key in object)typeof object[key]=="function"&&(object[key]=this.bind(object[key],object));return object},curry:function(f){var _a=Array.prototype.slice.call(arguments,1);return function(){var a=Array.prototype.slice.call(arguments);for(var i=_a.length-1;i>=0;i--)a.unshift(_a[i]);return f.apply(this,a)}},bind:function(callback,context){return context?function(){return callback.apply(context,arguments)}:callback},deprecate:function(methodName,replacement){console.trace(),console.log("WARNING: "+methodName+" is deprecated, use "+replacement+" instead")},highestAccess:function(a,b){return a=="rw"||b=="rw"?"rw":a=="r"||b=="r"?"r":null},getEventEmitter:function(){return this.bindAll({_handlers:function(){var eventNames=Array.prototype.slice.call(arguments),handlers={};return eventNames.forEach(function(name){handlers[name]=[]}),handlers}.apply(null,arguments),emit:function(eventName){var handlerArgs=Array.prototype.slice.call(arguments,1);if(!this._handlers[eventName])throw"Unknown event: "+eventName;this._handlers[eventName].forEach(function(handler){handler&&handler.apply(null,handlerArgs)})},once:function(eventName,handler){var i=this._handlers[eventName].length;if(typeof handler!="function")throw"Expected function as handler, got: "+typeof handler;this.on(eventName,function(){delete this._handlers[eventName][i],handler.apply(this,arguments)}.bind(this))},on:function(eventName,handler){if(!this._handlers[eventName])throw"Unknown event: "+eventName;if(typeof handler!="function")throw"Expected function as handler, got: "+typeof handler;this._handlers[eventName].push(handler)}})},getLogger:function(name){return loggers[name]||(loggers[name]={info:function(){this.log("info",util.toArray(arguments))},debug:function(){this.log("debug",util.toArray(arguments),"debug")},error:function(){this.log("error",util.toArray(arguments),"error")},log:function(level,args,type){if(logFn)return logFn(name,level,args);if(silentLogger[name])return;type||(type="log"),args.unshift("["+name.toUpperCase()+"] -- "+level+" "),(console[type]||console.log).apply(console,args)}}),loggers[name]},setLogFunction:function(logFunction){logFn=logFunction},silenceLogger:function(){var names=util.toArray(arguments);for(var i=0;i<names.length;i++)silentLogger[names[i]]=!0},unsilenceLogger:function(){var names=util.toArray(arguments);for(var i=0;i<names.length;i++)delete silentLogger[names[i]]},silenceAllLoggers:function(){this.silenceLogger.apply(this,knownLoggers)},unsilenceAllLoggers:function(){this.unsilenceLogger.apply(this,knownLoggers)},grepLocalStorage:function(pattern,iter){for(var i=0;i<localStorage.length;i++){var key=localStorage.key(i);pattern.test(key)&&iter(key)}}};return util}),define("lib/platform",["./util"],function(util){function normalizeHeaders(headers){var h={};for(var key in headers)h[key.toLowerCase()]=headers[key];return h}function browserParseHeaders(rawHeaders){if(!rawHeaders)return null;var headers={},lines=rawHeaders.split(/\r?\n/),lastKey=null,md,key,value;for(var i=0;i<lines.length;i++){if(lines[i].length==0)continue;(md=lines[i].match(/^([^:]+):\s*(.+)$/))?(key=md[1],value=md[2],headers[key]=value,lastKey=key):(md=lines[i].match(/^\s+(.+)$/))?(key=lastKey,value=md[1],headers[key]=headers[key]+value):logger.error("Failed to parse header line: "+lines[i])}return normalizeHeaders(headers)}function ajaxBrowser(params){var timedOut=!1,timer,xhr=new XMLHttpRequest;params.timeout&&(timer=window.setTimeout(function(){timedOut=!0,xhr.abort(),params.error("timeout")},params.timeout)),params.method||(params.method="GET"),xhr.open(params.method,params.url,!0);if(params.headers)for(var header in params.headers)xhr.setRequestHeader(header,params.headers[header]);xhr.onreadystatechange=function(){if(xhr.readyState==4){timer&&window.clearTimeout(timer);if(xhr.status==200||xhr.status==201||xhr.status==204||xhr.status==207){var headers=browserParseHeaders(xhr.getAllResponseHeaders());headers||(headers={"content-type":xhr.getResponseHeader("Content-Type")}),params.success(xhr.responseText,headers)}else params.error(xhr.status||"unknown error")}},typeof params.data=="string"?xhr.send(params.data):xhr.send()}function ajaxExplorer(params){var xdr=new XDomainRequest;xdr.timeout=params.timeout||3e3,xdr.open(params.method,params.url),xdr.onload=function(){xdr.status==200||xdr.status==201||xdr.status==204?params.success(xhr.responseText):params.error(xhr.status)},xdr.onerror=function(){err("unknown error")},xdr.ontimeout=function(){err(timeout)},params.data?xdr.send(params.data):xdr.send()}function ajaxNode(params){var http=require("http"),https=require("https"),url=require("url");params.method||(params.method="GET"),params.data?params.headers["content-length"]=params.data.length:params.data=null;var urlObj=url.parse(params.url),options={method:params.method,host:urlObj.hostname,path:urlObj.path,port:urlObj.port?port:urlObj.protocol=="https:"?443:80,headers:params.headers},timer,timedOut;params.timeout&&(timer=setTimeout(function(){params.error("timeout"),timedOut=!0},params.timeout));var lib=urlObj.protocol=="https:"?https:http,request=lib.request(options,function(response){var str="";response.setEncoding("utf8"),response.on("data",function(chunk){str+=chunk}),response.on("end",function(){timer&&clearTimeout(timer),timedOut||(response.statusCode==200||response.statusCode==201||response.statusCode==204?params.success(str,normalizeHeaders(response.headers)):params.error(response.statusCode))})});request.on("error",function(e){timer&&clearTimeout(timer),params.error(e.message)}),params.data?request.end(params.data):request.end()}function parseXmlBrowser(str,cb){var tree=(new DOMParser).parseFromString(str,"text/xml"),nodes=tree.getElementsByTagName("Link"),obj={Link:[]};for(var i=0;i<nodes.length;i++){var link={};if(nodes[i].attributes)for(var j=0;j<nodes[i].attributes.length;j++)link[nodes[i].attributes[j].name]=nodes[i].attributes[j].value;var props=nodes[i].getElementsByTagName("Property");link.properties={};for(var k=0;k<props.length;k++)link.properties[props[k].getAttribute("type")]=props[k].childNodes[0].nodeValue;link.rel&&obj.Link.push({"@":link})}cb(null,obj)}function parseXmlNode(str,cb){var xml2js=require("xml2js");(new xml2js.Parser).parseString(str,cb)}function harvestParamNode(){}function harvestParamBrowser(param){if(location.hash.length){var pairs=location.hash.substring(1).split("&");for(var i=0;i<pairs.length;i++)if(pairs[i].substring(0,(param+"=").length)==param+"="){var ret=decodeURIComponent(pairs[i].substring((param+"=").length));return delete pairs[i],location="#"+pairs.join("&"),ret}}}function setElementHtmlNode(eltName,html){}function setElementHtmlBrowser(eltName,html){var elt=eltName;elt instanceof Element||(elt=document.getElementById(eltName)),elt.innerHTML=html}function getElementValueNode(eltName){}function getElementValueBrowser(eltName){return document.getElementById(eltName).value}function eltOnNode(eltName,eventType,cb){}function eltOnBrowser(eltName,eventType,cb){eventType=="click"?document.getElementById(eltName).onclick=cb:eventType=="hover"?document.getElementById(eltName).onmouseover=cb:eventType=="type"&&(document.getElementById(eltName).onkeyup=cb)}function getLocationBrowser(){return window.location.href.split("#")[0]}function getLocationNode(){}function setLocationBrowser(location){window.location=location}function setLocationNode(){}function alertBrowser(str){alert(str)}function alertNode(str){console.log(str)}var logger=util.getLogger("platform");return typeof window=="undefined"?{ajax:ajaxNode,parseXml:parseXmlNode,harvestParam:harvestParamNode,setElementHTML:setElementHtmlNode,getElementValue:getElementValueNode,eltOn:eltOnNode,getLocation:getLocationNode,setLocation:setLocationNode,alert:alertNode}:window.XDomainRequest?{ajax:ajaxExplorer,parseXml:parseXmlBrowser,harvestParam:harvestParamBrowser,setElementHTML:setElementHtmlBrowser,getElementValue:getElementValueBrowser,eltOn:eltOnBrowser,getLocation:getLocationBrowser,setLocation:setLocationBrowser,alert:alertBrowser}:{ajax:ajaxBrowser,parseXml:parseXmlBrowser,harvestParam:harvestParamBrowser,setElementHTML:setElementHtmlBrowser,getElementValue:getElementValueBrowser,eltOn:eltOnBrowser,getLocation:getLocationBrowser,setLocation:setLocationBrowser,alert:alertBrowser}}),define("lib/webfinger",["./platform","./util"],function(platform,util){function userAddress2hostMetas(userAddress,cb){var parts=userAddress.toLowerCase().split("@");if(parts.length<2)cb("That is not a user address. There is no @-sign in it");else if(parts.length>2)cb("That is not a user address. There is more than one @-sign in it");else if(!/^[\.0-9a-z\-\_]+$/.test(parts[0]))cb('That is not a user address. There are non-dotalphanumeric symbols before the @-sign: "'+parts[0]+'"');else if(!/^[\.0-9a-z\-]+$/.test(parts[1]))cb('That is not a user address. There are non-dotalphanumeric symbols after the @-sign: "'+parts[1]+'"');else{var query="?resource=acct:"+encodeURIComponent(userAddress);cb(null,["https://"+parts[1]+"/.well-known/host-meta.json"+query,"https://"+parts[1]+"/.well-known/host-meta"+query,"http://"+parts[1]+"/.well-known/host-meta.json"+query,"http://"+parts[1]+"/.well-known/host-meta"+query])}}function fetchXrd(addresses,timeout,cb,errors){var firstAddress=addresses.shift();errors||(errors=[]),firstAddress?platform.ajax({url:firstAddress,success:function(data){parseAsJrd(data,function(err,obj){err?parseAsXrd(data,function(err,obj){err?fetchXrd(addresses,timeout,cb):cb(null,obj)}):cb(null,obj)})},error:function(error){errors.push(error),fetchXrd(addresses,timeout,cb,errors)},timeout:timeout}):cb("could not fetch XRD: "+errors[0])}function parseAsXrd(str,cb){platform.parseXml(str,function(err,obj){if(err)cb(err);else if(obj&&obj.Link){var links={};if(obj.Link&&obj.Link["@"])obj.Link["@"].rel&&(links[obj.Link["@"].rel]=obj.Link["@"]);else for(var i=0;i<obj.Link.length;i++)obj.Link[i]["@"]&&obj.Link[i]["@"].rel&&(links[obj.Link[i]["@"].rel]=obj.Link[i]["@"]);cb(null,links)}else cb("found valid xml but with no Link elements in there")})}function parseAsJrd(str,cb){var obj;try{obj=JSON.parse(str)}catch(e){cb("not valid JSON");return}obj.links||cb("JRD contains no links");var links={};for(var i=0;i<obj.links.length;i++)obj.links[i].rel&&(links[obj.links[i].rel]=obj.links[i]);cb(null,links)}function parseRemoteStorageLink(obj,cb){obj&&obj.href&&obj.type&&obj.properties&&obj.properties["auth-endpoint"]?cb(null,obj):cb("could not extract storageInfo from lrdd")}function getStorageInfo(userAddress,options,cb){userAddress2hostMetas(userAddress,function(err1,hostMetaAddresses){logger.debug("HOST META ADDRESSES",hostMetaAddresses,"(error: ",err1,")"),err1?cb(err1):fetchXrd(hostMetaAddresses,options.timeout,function(err2,hostMetaLinks){if(err2)cb("could not fetch host-meta for "+userAddress+" ("+err2+")");else if(hostMetaLinks.remoteStorage||hostMetaLinks.remotestorage)parseRemoteStorageLink(hostMetaLinks.remoteStorage||hostMetaLinks.remotestorage,cb);else if(hostMetaLinks.lrdd&&hostMetaLinks.lrdd.template){var parts=hostMetaLinks.lrdd.template.split("{uri}"),lrddAddresses=[parts.join("acct:"+userAddress),parts.join(userAddress)];fetchXrd(lrddAddresses,options.timeout,function(err4,lrddLinks){err4?cb("could not fetch lrdd for "+userAddress):lrddLinks.remoteStorage?parseRemoteStorageLink(lrddLinks.remoteStorage,cb):lrddLinks.remotestorage?parseRemoteStorageLink(lrddLinks.remotestorage,cb):cb("could not extract storageInfo from lrdd")})}else cb("could not extract lrdd template from host-meta")})})}var logger=util.getLogger("webfinger");return{getStorageInfo:getStorageInfo}}),define("lib/hardcoded",["./platform"],function(platform){function testIrisCouch(userAddress,options,cb){platform.ajax({url:"http://proxy.unhosted.org/irisCouchCheck?q=acct:"+userAddress,success:function(data){var obj;try{obj=JSON.parse(data)}catch(e){}obj?cb(null,obj):cb("err: unparsable response from IrisCouch check")},error:function(err){cb("err: during IrisCouch test:"+err)},timeout:options.timeout})}function mapToIrisCouch(userAddress){var parts=userAddress.split("@");return["libredocs","mail","browserid","me"].indexOf(parts[0])==-1?parts[0]+"@iriscouch.com":parts[2].substring(0,parts[2].indexOf("."))+"@iriscouch.com"}function guessStorageInfo(userAddress,options,cb){var parts=userAddress.split("@");if(parts.length<2)cb("That is not a user address. There is no @-sign in it");else if(parts.length>2)cb("That is not a user address. There is more than one @-sign in it");else if(!/^[\.0-9A-Za-z]+$/.test(parts[0]))cb('That is not a user address. There are non-dotalphanumeric symbols before the @-sign: "'+parts[0]+'"');else if(!/^[\.0-9A-Za-z\-]+$/.test(parts[1]))cb('That is not a user address. There are non-dotalphanumeric symbols after the @-sign: "'+parts[1]+'"');else{while(parts[1].indexOf(".")!=-1){if(guesses[parts[1]]){blueprint=guesses[parts[1]],cb(null,{rel:"https://www.w3.org/community/unhosted/wiki/personal-data-service-00",type:blueprint.type,href:blueprint.hrefPrefix+"/"+(blueprint.pathFormat=="user@host"?userAddress:parts[1]+"/"+parts[0]),properties:{"access-methods":["http://oauth.net/core/1.0/parameters/auth-header"],"auth-methods":["http://oauth.net/discovery/1.0/consumer-identity/static"],"auth-endpoint":blueprint.authPrefix+userAddress}});return}parts[1]=parts[1].substring(parts[1].indexOf(".")+1)}new Date<new Date("9/9/2012")?testIrisCouch(userAddress,options,cb):cb("err: not a guessable domain, and fakefinger-migration has ended")}}var guesses={"iriscouch.com":{type:"https://www.w3.org/community/unhosted/wiki/remotestorage-2011.10#couchdb",authPrefix:"http://proxy.unhosted.org/OAuth.html?userAddress=",hrefPrefix:"http://proxy.unhosted.org/CouchDb",pathFormat:"host/user"}};return function(){var surfnetSaml={type:"https://www.w3.org/community/unhosted/wiki/remotestorage-2011.10#simple",authPrefix:"https://storage.surfnetlabs.nl/saml/oauth/authorize?user_address=",hrefPrefix:"https://storage.surfnetlabs.nl/saml",pathFormat:"user@host"},surfnetBrowserId={type:"https://www.w3.org/community/unhosted/wiki/remotestorage-2011.10#simple",authPrefix:"https://storage.surfnetlabs.nl/browserid/oauth/authorize?user_address=",hrefPrefix:"https://storage.surfnetlabs.nl/browserid",pathFormat:"user@host"},dutchUniversitiesNoSaml=["leidenuniv.nl","leiden.edu","uva.nl","vu.nl","eur.nl","maastrichtuniversity.nl","ru.nl","rug.nl","uu.nl","tudelft.nl","utwente.nl","tue.nl","tilburguniversity.edu","uvt.nl","wur.nl","wageningenuniversity.nl","ou.nl","lumc.nl","amc.nl","ahk.nl","cah.nl","driestar.nl","che.nl","chn.nl","hen.nl","huygens.nl","diedenoort.nl","efa.nl","dehaagsehogeschool.nl","hasdenbosch.nl","inholland.nl","hsbrabant.nl","dehorst.nl","kempel.nl","domstad.nl","hsdrenthe.nl","edith.nl","hsleiden.nl","interport.nl","schumann.nl","hsbos.nl","hva.nl","han.nl","hvu.nl","hesasd.nl","hes-rdam.nl","hku.nl","hmtr.nl","hzeeland.nl","hotelschool.nl","ichtus-rdam.nl","larenstein.nl","iselinge.nl","koncon.nl","kabk.nl","lhump.nl","msm.nl","hsmarnix.nl","nhtv.nl","nth.nl","nhl.nl","sandberg.nl","hsij.nl","stoas.nl","thrijswijk.nl","tio.nl","vhall.nl","chw.nl","hogeschoolrotterdam.nl"],dutchUniversitiesSaml=["surfnet.nl","fontys.nl"];for(var i=0;i<dutchUniversitiesSaml.length;i++)guesses[dutchUniversitiesSaml[i]]=surfnetSaml;for(var i=0;i<dutchUniversitiesNoSaml.length;i++)guesses[dutchUniversitiesNoSaml[i]]=surfnetBrowserId}(),{guessStorageInfo:guessStorageInfo}}),define("lib/getputdelete",["./platform","./util"],function(platform,util){function getContentType(headers){return headers["content-type"]?headers["content-type"].split(";")[0]:(logger.error("Falling back to default content type: ",defaultContentType,JSON.stringify(headers)),defaultContentType)}function doCall(method,url,value,mimeType,token,cb,deadLine){logger.info(method,url);var platformObj={url:url,method:method,error:function(err){err==401?err="unauthorized":logger.error(method+" "+url+": ",err),cb(err)},success:function(data,headers){cb(null,data,getContentType(headers))},timeout:deadLine||5e3,headers:{}};token&&(platformObj.headers.Authorization="Bearer "+token),mimeType&&(platformObj.headers["Content-Type"]=mimeType),platformObj.fields={withCredentials:"true"},method!="GET"&&(platformObj.data=value),platform.ajax(platformObj)}function get(url,token,cb){doCall("GET",url,null,null,token,function(err,data,mimetype){if(err==404)cb(null,undefined);else if(err)cb(err);else{if(util.isDir(url))try{data=JSON.parse(data)}catch(e){cb("unparseable directory index");return}cb(null,data,mimetype)}})}function put(url,value,mimeType,token,cb){typeof value!="string"&&cb("invalid value given to PUT, only strings allowed, got "+typeof value),logger.info("calling PUT "+url," ("+value.length+")"),doCall("PUT",url,value,mimeType,token,function(err,data){cb(err,data)})}function set(url,valueStr,mimeType,token,cb){typeof valueStr=="undefined"?doCall("DELETE",url,null,null,token,cb):put(url,valueStr,mimeType,token,cb)}var logger=util.getLogger("getputdelete"),defaultContentType="application/octet-stream";return{get:get,set:set}}),define("lib/wireClient",["./getputdelete","./util"],function(getputdelete,util){function setSetting(key,value){localStorage.setItem(prefix+key,JSON.stringify(value)),calcState(),state=="connected"&&events.emit("connected")}function removeSetting(key){localStorage.removeItem(prefix+key)}function getSetting(key){var valStr=localStorage.getItem(prefix+key);if(typeof valStr=="string")try{return JSON.parse(valStr)}catch(e){localStorage.removeItem(prefix+key)}return null}function disconnectRemote(){util.grepLocalStorage(new RegExp("^"+prefix),function(key){localStorage.removeItem(key)})}function getState(){return state}function calcState(){return getSetting("storageType")&&getSetting("storageHref")?getSetting("bearerToken")?state="connected":state="authing":state="anonymous",state}function on(eventType,cb){events.on(eventType,cb)}function resolveKey(path){var storageHref=getSetting("storageHref");return storageHref+path}function isForeign(path){return foreignKeyRE.test(path)}function get(path,cb){if(isForeign(path))return getForeign(path,cb);state!="connected"&&cb(new Error("not-connected"));var token=getSetting("bearerToken");typeof path!="string"?cb(new Error('argument "path" should be a string')):getputdelete.get(resolveKey(path),token,cb)}function getForeign(fullPath,cb){var md=fullPath.match(foreignKeyRE),userAddress=md[1],path=md[2],base=getStorageHrefForUser(userAddress);getputdelete.get(base+path,null,cb)}function set(path,valueStr,mimeType,cb){if(isForeign(path))return cb(new Error("Foreign storage is read-only"));state!="connected"&&cb(new Error("not-connected"));var token=getSetting("bearerToken");typeof path!="string"?cb(new Error('argument "path" should be a string')):(valueStr&&typeof valueStr!="string"&&(valueStr=JSON.stringify(valueStr)),getputdelete.set(resolveKey(path),valueStr,mimeType,token,cb))}function remove(path,cb){if(isForeign(path))return cb(new Error("Foreign storage is read-only"));var token=getSetting("bearerToken");getputdelete.set(resolveKey(path),undefined,undefined,token,cb)}function getStorageHrefForUser(userAddress){var info=getSetting("storageInfo:"+userAddress);if(!info)throw new Error("userAddress unknown to wireClient: "+userAddress);return info.href}function addStorageInfo(userAddress,storageInfo){setSetting("storageInfo:"+userAddress,storageInfo)}function hasStorageInfo(userAddress){return!!getSetting("storageInfo:"+userAddress)}var prefix="remote_storage_wire_",events=util.getEventEmitter("connected","error"),state="anonymous",foreignKeyRE=/^([^\/][^:]+):(\/.*)$/;return{get:get,set:set,remove:remove,setStorageInfo:function(type,href){setSetting("storageType",type),setSetting("storageHref",href)},getStorageHref:function(){return getSetting("storageHref")},setBearerToken:function(bearerToken){setSetting("bearerToken",bearerToken)},addStorageInfo:addStorageInfo,hasStorageInfo:hasStorageInfo,disconnectRemote:disconnectRemote,on:on,getState:getState,calcState:calcState}}),define("lib/store",["./util"],function(util){function fireChange(origin,path,oldValue){var node=getNode(path);events.emit("change",{path:path,origin:origin,oldValue:oldValue,newValue:getNodeData(path),timestamp:node.timestamp})}function fireForeignChange(path,oldValue){var node=getNode(path);events.emit("foreign-change",{path:path,oldValue:oldValue,newValue:getNodeData(path),timestamp:node.timestamp})}function getNode(path){if(!path)throw new Error("No path given!");validPath(path);var valueStr=localStorage.getItem(prefixNodes+path),value;if(valueStr)try{value=JSON.parse(valueStr)}catch(e){logger.error("Invalid node data in store: ",valueStr)}return value||(value={startAccess:null,startForce:null,startForceTree:null,timestamp:0,lastUpdatedAt:0,mimeType:"application/json"},util.isDir(path)&&(value.diff={})),value}function forget(path){validPath(path),localStorage.removeItem(prefixNodes+path),localStorage.removeItem(prefixNodesData+path)}function forgetAll(){for(var i=0;i<localStorage.length;i++)if(localStorage.key(i).substr(0,prefixNodes.length)==prefixNodes||localStorage.key(i).substr(0,prefixNodesData.length)==prefixNodesData)localStorage.removeItem(localStorage.key(i)),i--}function setNodeData(path,data,outgoing,timestamp,mimeType){var node=getNode(path),oldValue;outgoing||(node.lastUpdatedAt=timestamp,oldValue=getNodeData(path)),mimeType||(mimeType="application/json"),node.mimeType=mimeType,updateNodeData(path,data),updateNode(path,data?node:undefined,outgoing,!1,timestamp,oldValue)}function getNodeData(path,raw){logger.info("GET",path),validPath(path);var valueStr=localStorage.getItem(prefixNodesData+path),node=getNode(path);if(valueStr){if(!raw&&node.mimeType=="application/json")try{return JSON.parse(valueStr)}catch(exc){events.emit("error","Invalid JSON node at "+path+": "+valueStr)}return valueStr}return undefined}function removeNode(path){setNodeData(path,undefined,!1)}function setNodeAccess(path,claim){var node=getNode(path);claim!=node.startAccess&&(claim=="rw"||node.startAccess==null)&&(node.startAccess=claim,updateNode(path,node,!1,!0))}function setNodeForce(path,dataFlag,treeFlag){var node=getNode(path);node.startForce=dataFlag,node.startForceTree=treeFlag,updateNode(path,node,!1,!0)}function setNodeError(path,error){var node=getNode(path);error?node.error=error:delete node.error,updateNode(path,node,!1,!0)}function clearDiff(path,timestamp){logger.debug("clearDiff",path);var node=getNode(path);timestamp&&(node.timestamp=node.lastUpdatedAt=timestamp,updateNode(path,node,!1,!0));var parentPath=util.containingDir(path),baseName=util.baseName(path);if(parentPath){var parent=getNode(parentPath);delete parent.diff[baseName],updateNode(parentPath,parent,!1,!0),Object.keys(parent.diff).length===0&&clearDiff(parentPath)}}function fireInitialEvents(){function iter(path){if(util.isDir(path)){var listing=getNodeData(path);if(listing)for(var key in listing)iter(path+key)}else fireChange("device",path)}logger.info("fire initial events"),iter("/")}function isPrefixed(key){return key.substring(0,prefixNodes.length)==prefixNodes}function getFileName(path){var parts=path.split("/");return util.isDir(path)?parts[parts.length-2]+"/":parts[parts.length-1]}function getCurrTimestamp(){return(new Date).getTime()}function validPath(path){if(path[0]!="/"&&!userAddressRE.test(path))throw new Error("Invalid path: "+path)}function isForeign(path){return path[0]!="/"}function determineDirTimestamp(path){var data=getNodeData(path);if(data){var times=[];for(var key in data)times.push(data[key]);return Math.max.apply(Math,times)}return getCurrTimestamp()}function updateNodeData(path,data){validPath(path);if(!path)throw new Error("Path is required!");var encodedData;typeof data!="undefined"?(typeof data=="object"?encodedData=JSON.stringify(data):encodedData=data,localStorage.setItem(prefixNodesData+path,encodedData)):localStorage.removeItem(prefixNodesData+path)}function updateNode(path,node,outgoing,meta,timestamp,oldValue){validPath(path);if(!meta&&!timestamp)if(outgoing)timestamp=getCurrTimestamp();else{if(!util.isDir(path))throw new Error("no timestamp given for node "+path);timestamp=determineDirTimestamp(path)}node&&typeof timestamp!="undefined"&&(node.timestamp=timestamp),node?localStorage.setItem(prefixNodes+path,JSON.stringify(node)):localStorage.removeItem(prefixNodes+path);var containingDir=util.containingDir(path);if(containingDir){var parentNode=getNode(containingDir),parentData=getNodeData(containingDir)||{},baseName=getFileName(path);if(meta){if(!parentData||!parentData[baseName])parentData[baseName]=0,updateNodeData(containingDir,parentData);updateNode(containingDir,parentNode,!1,!0,timestamp)}else if(outgoing)node?parentData[baseName]=timestamp:delete parentData[baseName],parentNode.diff[baseName]=timestamp,updateNodeData(containingDir,parentData),updateNode(containingDir,parentNode,!0,!1,timestamp);else{if(node){if(!parentData[baseName]||parentData[baseName]<timestamp)parentData[baseName]=timestamp,delete parentNode.diff[baseName],updateNodeData(containingDir,parentData),updateNode(containingDir,parentNode,!1,!1,timestamp)}else parentData[baseName]&&(delete parentData[baseName],delete parentNode.diff[baseName],updateNodeData(containingDir,parentData),updateNode(containingDir,parentNode,!1,!1,timestamp));util.isDir(path)||(isForeign(path)?fireForeignChange(path,oldValue):fireChange("remote",path,oldValue))}}}var logger=util.getLogger("store"),prefixNodes="remote_storage_nodes:",prefixNodesData="remote_storage_node_data:",userAddressRE=/^[^@]+@[^:]+:\//,events=util.getEventEmitter("error","change","foreign-change");return typeof window!="undefined"&&window.addEventListener("storage",function(event){isPrefixed(event.key)&&(util.isDir(event.key)||fireChange("device",event.key.substring(prefixNodes.length),event.oldValue))}),{getNode:getNode,getNodeData:getNodeData,setNodeData:setNodeData,clearDiff:clearDiff,removeNode:removeNode,setNodeError:setNodeError,on:events.on,setNodeAccess:setNodeAccess,setNodeForce:setNodeForce,forget:forget,forgetAll:forgetAll,fireInitialEvents:fireInitialEvents}}),define("lib/sync",["./wireClient","./store","./util"],function(wireClient,store,util){function getSetting(key){var data=localStorage.getItem(settingsPrefix+key);try{data=JSON.parse(data)}catch(e){}return data}function setSetting(key,value){return typeof value!="string"&&(value=JSON.stringify(value)),localStorage.setItem(settingsPrefix+key,value)}function clearSettings(){for(var i=0;i<localStorage.length;i++){var key=localStorage.key(i);key.match(new RegExp("^"+settingsPrefix))&&localStorage.removeItem(key)}}function needsSync(path){var listing=store.getNodeData("/");for(var key in listing)if(util.isDir(key)&&Object.keys(store.getNode("/"+key).diff).length>0)return!0;return!1}function fullSync(callback,pushOnly){function rootCb(){synced++,synced==roots.length&&callback&&callback.apply(this,arguments)}if(!isConnected())return callback&&callback("not-connected");logger.info("full "+(pushOnly?"push":"sync")+" started");var roots=findRoots(),synced=0;if(roots.length==0){logger.info("full sync not happening. no access claimed.");return}roots.forEach(function(root){enqueueTask(function(){traverseTree(root,processNode,{pushOnly:pushOnly})},rootCb)})}function fullPush(callback){fullSync(callback,!0)}function partialSync(startPath,depth,callback){if(!isConnected())return callback&&callback("not-connected");validatePath(startPath),logger.info("partial sync requested: "+startPath),enqueueTask(function(){logger.info("partial sync started from: "+startPath),events.once("ready",callback),traverseTree(startPath,processNode,{depth:depth})})}function syncOne(path,callback){if(!isConnected())return callback&&callback("not-connected");validatePath(path,!0),logger.info("single sync requested: "+path),enqueueTask(function(){logger.info("single sync started: "+path),fetchRemoteNode(path,function(remoteNode){var localNode=fetchLocalNode(path);processNode(path,localNode,remoteNode),callback&&callback(null,store.getNode(path),store.getNodeData(path))})})}function enqueueTask(callback,finalizer){ready?(currentFinalizer=finalizer,callback()):taskQueue.push({run:callback,finalizer:finalizer})}function setBusy(){ready=!1,events.emit("state","busy"),events.emit("busy")}function setReady(){ready=!0,deferredIterationQueue.length>0?spawnQueue.apply(this,deferredIterationQueue.shift()):(events.emit("state","connected"),events.emit("ready"))}function tryReady(){ready&&deferredIterationQueue.length==0&&events.emit("ready")}function getState(){return ready?"connected":"busy"}function fireConflict(type,path,local,remote){events.emit("conflict",{type:type,path:path,localValue:local.data,remoteValue:remote.data,localTime:new Date(local.timestamp),remoteTime:new Date(remote.timestamp),lastUpdate:new Date(local.lastUpdatedAt),resolve:makeConflictResolver(path,local,remote)})}function fireError(path,error){var event={path:path};typeof error=="object"?(event.stack=error.stack,typeof (event.stack=="string")&&(event.stack=event.stack.split("\n")),event.message=error.message,event.exception=error):event.message=error,events.emit("error",event)}function deleteLocal(path,local,remote){logger.info("DELETE",path,"REMOTE -> LOCAL");var oldValue=store.getNodeData(path);store.removeNode(path)}function deleteRemote(path,local,remote){logger.info("DELETE",path,"LOCAL -> REMOTE"),wireClient.remove(path,makeErrorCatcher(path,util.curry(store.clearDiff,path)))}function updateLocal(path,local,remote){logger.info("UPDATE",path,"REMOTE -> LOCAL"),store.setNodeData(path,remote.data,!1,remote.timestamp,remote.mimeType)}function updateRemote(path,local,remote){logger.info("UPDATE",path,"LOCAL -> REMOTE"),wireClient.set(path,local.data,local.mimeType,makeErrorCatcher(path,function(){fetchNode(util.containingDir(path),function(listing){store.clearDiff(path,listing[util.baseName(path)])})}))}function processNode(path,local,remote){var action=null;if(local.deleted)logger.debug(path,"outgoing delete"),action=deleteRemote;else if(remote.deleted&&local.lastUpdatedAt>0)local.timestamp==local.lastUpdatedAt?(logger.debug(path,"incoming delete"),action=deleteLocal):(logger.debug(path,"deletion conflict","remote",remote,"local",local),action=util.curry(fireConflict,"delete"));else{if(local.timestamp==remote.timestamp){logger.debug(path,"no action today");return}local.timestamp>remote.timestamp?local.lastUpdatedAt==remote.timestamp?(logger.debug(path,"outgoing update"),action=updateRemote):(logger.debug(path,"merge conflict (local > remote)","remote",remote,"local",local),action=util.curry(fireConflict,"merge")):local.timestamp<remote.timestamp&&(local.lastUpdatedAt==local.timestamp?(logger.debug(path,"incoming update"),action=updateLocal):(logger.debug(path,"merge conflict (local < remote)","remote",remote,"local",local),action=util.curry(fireConflict,"merge")))}if(!action){var exc=new Error("Something went terribly wrong.");throw exc.path=path,exc.localNode=local,exc.remoteNode=remote,exc}action(path,local,remote)}function fetchLocalNode(path,isDeleted){logger.info("fetch local",path);var localNode=store.getNode(path);localNode.data=store.getNodeData(path),isForeignPath(path)&&(isDeleted=!1);if(typeof isDeleted=="undefined"){var parentPath=util.containingDir(path);if(parentPath){var baseName=util.baseName(path),parent=store.getNode(parentPath),parentData=store.getNodeData(parentPath);isDeleted=!parentData[baseName]&&parent.diff[baseName]}else isDeleted=!1}return localNode.deleted=isDeleted,localNode}function fetchNode(path,callback){logger.info("fetch remote",path),wireClient.get(path,function(err,data,mimeType){if(err)fireError(path,err);else try{callback(data,mimeType)}catch(exc){fireError(path,exc)}})}function prepareRemoteNode(data,mimeType,timestamp){return{timestamp:timestamp,data:data,deleted:timestamp==0,mimeType:mimeType}}function fetchRemoteNode(path,parentData,callback){function done(data,mimeType){callback(prepareRemoteNode(data,mimeType,parentData&&parentData[util.baseName(path)]||(isForeign?(new Date).getTime():0)))}var isForeign=isForeignPath(path);if(callback)fetchNode(path,done);else{callback=parentData,parentData=null;var parentPath=util.containingDir(path);isForeign?fetchNode(path,done):parentPath?fetchNode(parentPath,function(data){parentData=data,fetchNode(path,done)}):fetchNode(path,done)}}function isConnected(){return wireClient.getState()=="connected"}function makeSet(a,b){var o={};for(var i=0;i<a.length;i++)o[a[i]]=!0;for(var j=0;j<b.length;j++)o[b[j]]=!0;return Object.keys(o)}function isOwnPath(path){return ownPathRE.test(path)}function isForeignPath(path){return foreignPathRE.test(path)}function validPath(path,foreignOk){return isOwnPath(path)||(foreignOk?isForeignPath(path):!1)}function validatePath(path,foreignOk){if(!validPath(path,foreignOk))throw new Error("Invalid path: "+path)}function findRoots(path){var root=store.getNode("/"),roots=[];return root.startAccess?roots.push("/"):Object.keys(store.getNodeData("/")).forEach(function(key){store.getNode("/"+key).startAccess&&roots.push("/"+key)}),roots}function findAccess(path){if(!path)return null;var node=store.getNode(path);return node.startAccess?node.startAccess:findAccess(util.containingDir(path))}function traverseTree(root,callback,opts){logger.info("traverse",root);if(!util.isDir(root))throw"Can't traverse data node: "+root;opts||(opts={});var done=opts.done||function(){};(opts.depth||opts.depth==0)&&logger.debug("traverse depth",opts.depth,root);var localRootNode=store.getNode(root),localListing=store.getNodeData(root);localListing||(localListing={},store.setNodeData(root,localListing,!1,0,"application/json")),opts.access=util.highestAccess(opts.access,localRootNode.startAccess),opts.force=opts.force||localRootNode.startForce,opts.forceTree=opts.forceTree||localRootNode.startForceTree,opts.access||(opts.access=findAccess(util.containingDir(root)));if(!opts.access&&root!="/"&&!opts.force&&!opts.forceTree){logger.debug("skipping",root,"no interest","(access: ",opts.access," force: ",opts.force," forceTree: ",opts.forceTree,")"),tryReady(),done();return}var localDiff=Object.keys(localRootNode.diff).length>0;if(!localDiff&&opts.pushOnly){tryReady(),done();return}fetchNode(root,function(remoteListing){remoteListing||(remoteListing={}),done();var fullListing=makeSet(Object.keys(remoteListing),Object.keys(localListing));opts.forceTree&&!opts.force&&Object.keys(localListing).length==0&&(fullListing.forEach(function(key){localListing[key]=0}),store.setNodeData(root,localListing,!1,0,"application/json"));if(!localDiff){var remoteDiff=!1;for(var i=0;i<fullListing.length;i++){var item=fullListing[i];if(localListing[item]!=remoteListing[item]){remoteDiff=!0;break}}if(!remoteDiff){logger.debug("skipping",root,"no changes"),tryReady();return}}spawnQueue(fullListing,6,function(item,next){var path=root+item;if(util.isDir(item))if(opts.depth&&opts.depth==1)next();else{var newOpts=util.extend({},opts);newOpts.depth&&newOpts.depth--,newOpts.done=next,traverseTree(path,callback,newOpts)}else opts.force?fetchRemoteNode(path,remoteListing,function(remoteNode){var localNode=fetchLocalNode(path,!localListing[item]&&localRootNode.diff[item]);callback(path,localNode,remoteNode),next()}):next()})})}function makeConflictResolver(path,local,remote){return function(solution,newData){if(solution=="local")newData&&(local.data=newData),updateRemote(path,local,remote);else{if(solution!="remote")throw"Invalid conflict resolution: "+solution;updateLocal(path,local,remote)}}}function makeErrorCatcher(path,callback){return function(error){if(error)fireError(path,error);else if(callback){var args=Array.prototype.slice.call(arguments,1);callback.apply(this,args)}}}function spawnQueue(list,max,iter){function next(){n++,iter(list[i++],done)}function done(){n--,i==list.length&&n==0?setReady():i<list.length&&spawn()}function spawn(){while(n<max&&i<list.length)next()}if(!ready){deferredIterationQueue.push([list,max,iter]);return}setBusy();var n=0,i=0;setTimeout(spawn,1)}function limit(name,syncFunction,minInterval){return function(){var args=Array.prototype.slice.call(arguments),callback=args.slice(-1)[0],plainArgs=args;typeof callback=="function"?plainArgs=args.slice(0,-1):callback=null;var now=(new Date).getTime(),cacheKey=[name,plainArgs],limitCache=getSetting("limitCache")||{};limitCache[cacheKey]&&limitCache[cacheKey]>now-minInterval?(logger.debug("limit",name,"-> replay"),callback&&callback()):(logger.debug("limit",name,"-> call through"),limitCache[cacheKey]=now,setSetting("limitCache",limitCache),syncFunction.apply(this,args))}}var events=util.getEventEmitter("error","conflict","state","busy","ready"),logger=util.getLogger("sync"),settingsPrefix="remote_storage_sync:",ready=!0,deferredIterationQueue=[],taskQueue=[],currentFinalizer=null;events.on("ready",function(){logger.info("READY","queued tasks: ",taskQueue.length),currentFinalizer&&(currentFinalizer(),currentFinalizer=null);if(taskQueue.length>0){var nextTask=taskQueue.shift();currentFinalizer=nextTask.finalizer,nextTask.run()}});var foreignPathRE=/^[^\/][^:]+:\//,ownPathRE=/^\//;events.on("error",function(error){logger.error("Error: ",error)});var limitedFullSync=limit("fullSync",fullSync,3e4),limitedPartialSync=limit("partialSync",partialSync,3e4),sync={fullSync:limitedFullSync,forceSync:fullSync,fullPush:fullPush,partialSync:limitedPartialSync,syncOne:syncOne,needsSync:needsSync,getState:getState,on:events.on,clearSettings:clearSettings,syncNow:function(path,callback){util.deprecate("sync.syncNow","sync.fullSync"),this.fullSync(callback)},fetchNow:function(path,callback){util.deprecate("sync.fetchNow","sync.syncOne or sync.partialSync"),this.syncOne(path,callback)},disableThrottling:function(){sync.fullSync=fullSync,sync.partialSync=partialSync}};return sync}),define("lib/widget",["./assets","./webfinger","./hardcoded","./wireClient","./sync","./store","./platform","./util"],function(assets,webfinger,hardcoded,wireClient,sync,store,platform,util){function translate(text){return text}function calcWidgetState(){var wireClientState=wireClient.getState();return wireClientState=="connected"?sync.getState():wireClientState}function setWidgetStateOnLoad(){setWidgetState(calcWidgetState())}function setWidgetState(state,updateView){widgetState=state,updateView!==!1&&displayWidgetState(state,userAddress),events.emit("state",state)}function getWidgetState(){return widgetState}function buildWidget(){function el(tag,id,attrs){var e=document.createElement(tag);id&&e.setAttribute("id",id),attrs&&attrs._content&&(e.innerHTML=attrs._content,delete attrs._content);for(var key in attrs)e.setAttribute(key,attrs[key]);return e}var widget={root:el("div","remotestorage-state"),connectButton:el("input","remotestorage-connect-button",{"class":"remotestorage-button",type:"submit",value:translate("connect")}),registerButton:el("span","remotestorage-register-button",{"class":"remotestorage-button",_content:translate("get remotestorage")}),cube:el("img","remotestorage-cube",{src:assets.remoteStorageCube}),bubble:el("span","remotestorage-bubble"),helpHint:el("a","remotestorage-questionmark",{href:"http://unhosted.org/#remotestorage",target:"_blank"}),helpText:el("span","remotestorage-infotext",{"class":"infotext",_content:"This app allows you to use your own data storage!<br/>Click for more info on the Unhosted movement."}),userAddress:el("input","remotestorage-useraddress",{placeholder:"user@host"}),style:el("style")};return widget.root.appendChild(widget.connectButton),widget.root.appendChild(widget.registerButton),widget.root.appendChild(widget.cube),widget.root.appendChild(widget.bubble),widget.root.appendChild(widget.helpHint),widget.root.appendChild(widget.helpText),widget.root.appendChild(widget.userAddress),widget.style.innerHTML=assets.widgetCss,widget}function displayWidgetState(state,userAddress){if(state==="authing")return platform.alert("Authentication was aborted. Please try again."),setWidgetState("typing");if(!widget){var root=document.getElementById(connectElement);widget=buildWidget(),widget.registerButton.addEventListener("click",handleRegisterButtonClick),widget.connectButton.addEventListener("click",handleConnectButtonClick),widget.bubble.addEventListener("click",handleBubbleClick),widget.cube.addEventListener("click",handleCubeClick),widget.userAddress.addEventListener("keyup",handleWidgetTypeUserAddress),root.appendChild(widget.style),root.appendChild(widget.root)}widget.root.setAttribute("class",state);var userAddress=localStorage.remote_storage_widget_useraddress||"";userAddress?(widget.userAddress.value=userAddress,userAddress="<strong>"+userAddress+"</strong>"):userAddress="<strong>(n/a)</strong>";var bubbleText="",bubbleVisible=!1;initialSync?(bubbleText="Connecting "+userAddress,bubbleVisible=!0):state=="connected"?bubbleText="Disconnect "+userAddress:state=="busy"?bubbleText="Synchronizing "+userAddress+"...":state=="offline"&&(offlineReason=="unauthorized"?(bubbleText="Access denied by remotestorage. Click to reconnect.",bubbleVisible=!0):bubbleText="Offline ("+userAddress+")"),widget.bubble.innerHTML=bubbleText,bubbleVisible?(widget.cube.setAttribute("style","opacity:1"),widget.bubble.setAttribute("style","display:inline")):(widget.cube.removeAttribute("style"),widget.bubble.removeAttribute("style")),state==="typing"&&widget.userAddress.focus()}function handleRegisterButtonClick(){window.open("http://unhosted.org/en/a/register.html","Get your remote storage",popupSettings)}function redirectUriToClientId(loc){if(loc.substring(0,"http://".length)=="http://")loc=loc.substring("http://".length);else{if(loc.substring(0,"https://".length)!="https://")return loc;loc=loc.substring("https://".length)}var hostParts=loc.split("/")[0].split("@");return hostParts.length>2?loc:(hostParts.length==2&&hostParts.shift(),hostParts[0])}function prepareAuthPopup(){authPopupRef=window.open(document.location,"remotestorageAuthPopup",popupSettings+",dependent=yes"),window.remotestorageTokenReceived=function(){delete window.remotestorageTokenReceived,setWidgetStateOnLoad()}}function closeAuthPopup(){authPopupRef.close()}function setAuthPopupLocation(location){authPopupRef.document.location=location}function finalizeAuthPopup(){if(!frames.opener)return;frames.opener.remotestorageTokenReceived(),window.close()}function dance(){var endpoint=localStorage.remote_storage_widget_auth_endpoint,endPointParts=endpoint.split("?"),queryParams=[];endPointParts.length==2?queryParams=endPointParts[1].split("&"):endPointParts.length>2&&errorHandler("more than one questionmark in auth-endpoint - ignoring");var loc=platform.getLocation(),scopesArr=[];for(var i in scopesObj)scopesArr.push(i+":"+scopesObj[i]);queryParams.push("response_type=token"),queryParams.push("scope="+encodeURIComponent(scopesArr.join(" "))),queryParams.push("redirect_uri="+encodeURIComponent(loc)),queryParams.push("client_id="+encodeURIComponent(redirectUriToClientId(loc)));var authLocation=endPointParts[0]+"?"+queryParams.join("&");if(typeof authDialogStrategy=="function")authDialogStrategy(authLocation);else switch(authDialogStrategy){case"redirect":platform.setLocation(authLocation);break;case"popup":setAuthPopupLocation(authLocation);break;default:throw"Invalid strategy for auth dialog: "+authDialogStrategy}}function discoverStorageInfo(userAddress,cb){webfinger.getStorageInfo(userAddress,{timeout:5e3},function(err,data){err?hardcoded.guessStorageInfo(userAddress,{timeout:5e3},function(err2,data2){err2?(logger.debug("Error from fakefinger: "+err2),cb(err)):data2.type&&data2.href&&data.properties&&data.properties["auth-endpoint"]?(wireClient.setStorageInfo(data2.type,data2.href),cb(null,data2.properties["auth-endpoint"])):cb("cannot make sense of storageInfo from webfinger")}):data.type&&data.href&&data.properties&&data.properties["auth-endpoint"]?(wireClient.setStorageInfo(data.type,data.href),cb(null,data.properties["auth-endpoint"])):cb("cannot make sense of storageInfo from hardcoded")})}function tryWebfinger(userAddress,retryCount){typeof retryCount=="undefined"&&(retryCount=0),discoverStorageInfo(userAddress,function(err,auth){err?(err=="timeout"&&retryCount!=maxRetryCount?tryWebfinger(userAddress,retryCount+1):platform.alert("webfinger discovery failed! Please check if your user address is correct and try again. If the problem persists, contact your storage provider for support. (Error is: "+err+")"),authDialogStrategy=="popup"&&closeAuthPopup(),setWidgetState("failed")):(localStorage.remote_storage_widget_auth_endpoint=auth,dance())})}function handleConnectButtonClick(){widgetState=="typing"?(userAddress=widget.userAddress.value,localStorage.remote_storage_widget_useraddress=userAddress,setWidgetState("connecting"),authDialogStrategy=="popup"&&prepareAuthPopup(),tryWebfinger(userAddress)):setWidgetState("typing")}function handleBubbleClick(){widgetState=="connected"||widgetState=="busy"?sync.fullPush(function(){wireClient.disconnectRemote(),store.forgetAll(),sync.clearSettings(),setWidgetState("disconnected",!0),setWidgetState("anonymous")}):widgetState=="offline"&&offlineReason=="unauthorized"&&dance()}function handleCubeClick(){(widgetState=="connected"||widgetState=="connected")&&handleBubbleClick()}function handleWidgetTypeUserAddress(event){event.keyCode===13&&widget.connectButton.click()}function handleWidgetHover(){logger.debug("handleWidgetHover")}function nowConnected(){console.log("NOW CONNECTED"),setWidgetState("connected"),initialSync=!0,store.fireInitialEvents(),sync.forceSync(function(){logger.info("Initial sync done."),initialSync=!1,setWidgetState(getWidgetState()),events.emit("ready")})}function display(setConnectElement,options){var tokenHarvested=platform.harvestParam("access_token"),storageRootHarvested=platform.harvestParam("storage_root"),storageApiHarvested=platform.harvestParam("storage_api"),authorizeEndpointHarvested=platform.harvestParam("authorize_endpoint");options||(options={}),sync.on("error",function(error){error.message=="unauthorized"&&(offlineReason="unauthorized",initialSync&&(initialSync=!1,events.emit("ready")),setWidgetState("offline"))}),connectElement=setConnectElement,wireClient.calcState()=="connected"?nowConnected():wireClient.on("connected",nowConnected),wireClient.on("error",function(err){platform.alert(translate(err))}),sync.on("state",setWidgetState),typeof options.authDialog!="undefined"&&(authDialogStrategy=options.authDialog),locale=options.locale,tokenHarvested&&(wireClient.setBearerToken(tokenHarvested),authDialogStrategy==="popup"&&finalizeAuthPopup()),storageRootHarvested&&wireClient.setStorageInfo(storageApiHarvested?storageApiHarvested:"2012.04",storageRootHarvested),authorizeEndpointHarvested&&(localStorage.remote_storage_widget_auth_endpoint=authorizeEndpointHarvested,dance()),setWidgetStateOnLoad(),options.syncShortcut!==!1&&(window.onkeydown=function(evt){if(evt.ctrlKey&&evt.which==83)return evt.preventDefault(),sync.fullSync(),!1}),window.onbeforeunload=function(event){if(widgetState!="anonymous"&&sync.needsSync()){sync.fullPush();var message="Synchronizing your data now. Please wait until the cube stops spinning.";return event.returnValue=message,message}}}function addScope(module,mode){if(!scopesObj[module]||mode=="rw")scopesObj[module]=mode}var locale="en",connectElement,widgetState,userAddress,authDialogStrategy="redirect",authPopupRef,initialSync,scopesObj={},widget,offlineReason,events=util.getEventEmitter("state","ready"),popupSettings="resizable,toolbar=yes,location=yes,scrollbars=yes,menubar=yes,width=820,height=800,top=0,left=0",logger=util.getLogger("widget"),maxRetryCount=2;return{display:display,addScope:addScope,getState:getWidgetState,on:events.on}}),define("lib/nodeConnect",["./wireClient","./webfinger"],function(wireClient,webfinger){return{setUserAddress:function(userAddress,callback){webfinger.getStorageInfo(userAddress,{timeout:3e3},function(err,data){err?console.error("Failed to look up storage info for user "+userAddress+": ",err):wireClient.setStorageInfo(data.type,data.href),callback(err)})},setStorageInfo:wireClient.setStorageInfo,setBearerToken:wireClient.setBearerToken}}),define("lib/validate",[],function(){function validate(instance,schema){return validate(instance,schema,{changing:!1})}var exports=validate;exports.Integer={type:"integer"};var primitiveConstructors={String:String,Boolean:Boolean,Number:Number,Object:Object,Array:Array,Date:Date};exports.validate=validate,exports.checkPropertyChange=function(value,schema,property){return validate(value,schema,{changing:property||"property"})};var validate=exports._validate=function(instance,schema,options){function getType(schema){return schema.type||primitiveConstructors[schema.name]==schema&&schema.name.toLowerCase()}function checkProp(value,schema,path,i){function addError(message){errors.push({property:path,message:message})}function checkType(type,value){if(type){if(!(typeof type!="string"||type=="any"||(type=="null"?value===null:typeof value==type)||value instanceof Array&&type=="array"||value instanceof Date&&type=="date"||type=="integer"&&value%1===0))return[{property:path,message:typeof value+" value found, but a "+type+" is required"}];if(type instanceof Array){var unionErrors=[];for(var j=0;j<type.length;j++)if(!(unionErrors=checkType(type[j],value)).length)break;if(unionErrors.length)return unionErrors}else if(typeof type=="object"){var priorErrors=errors;errors=[],checkProp(value,type,path);var theseErrors=errors;return errors=priorErrors,theseErrors}}return[]}var l;path+=path?typeof i=="number"?"["+i+"]":typeof i=="undefined"?"":"."+i:i;if((typeof schema!="object"||schema instanceof Array)&&(path||typeof schema!="function")&&(!schema||!getType(schema)))return typeof schema=="function"?value instanceof schema||addError("is not an instance of the class/constructor "+schema.name):schema&&addError("Invalid schema/property definition "+schema),null;_changing&&schema.readonly&&addError("is a readonly field, it can not be changed"),schema["extends"]&&checkProp(value,schema["extends"],path,i);if(value===undefined)schema.required&&addError("is missing and it is required");else{errors=errors.concat(checkType(getType(schema),value)),schema.disallow&&!checkType(schema.disallow,value).length&&addError(" disallowed value was matched");if(value!==null){if(value instanceof Array){if(schema.items){var itemsIsArray=schema.items instanceof Array,propDef=schema.items;for(i=0,l=value.length;i<l;i+=1)itemsIsArray&&(propDef=schema.items[i]),options.coerce&&(value[i]=options.coerce(value[i],propDef)),errors.concat(checkProp(value[i],propDef,path,i))}schema.minItems&&value.length<schema.minItems&&addError("There must be a minimum of "+schema.minItems+" in the array"),schema.maxItems&&value.length>schema.maxItems&&addError("There must be a maximum of "+schema.maxItems+" in the array")}else(schema.properties||schema.additionalProperties)&&errors.concat(checkObj(value,schema.properties,path,schema.additionalProperties));schema.pattern&&typeof value=="string"&&!value.match(schema.pattern)&&addError("does not match the regex pattern "+schema.pattern),schema.maxLength&&typeof value=="string"&&value.length>schema.maxLength&&addError("may only be "+schema.maxLength+" characters long"),schema.minLength&&typeof value=="string"&&value.length<schema.minLength&&addError("must be at least "+schema.minLength+" characters long"),typeof schema.minimum!==undefined&&typeof value==typeof schema.minimum&&schema.minimum>value&&addError("must have a minimum value of "+schema.minimum),typeof schema.maximum!==undefined&&typeof value==typeof schema.maximum&&schema.maximum<value&&addError("must have a maximum value of "+schema.maximum);if(schema["enum"]){var enumer=schema["enum"];l=enumer.length;var found;for(var j=0;j<l;j++)if(enumer[j]===value){found=1;break}found||addError("does not have a value in the enumeration "+enumer.join(", "))}typeof schema.maxDecimal=="number"&&value.toString().match(new RegExp("\\.[0-9]{"+(schema.maxDecimal+1)+",}"))&&addError("may only have "+schema.maxDecimal+" digits of decimal places")}}return null}function checkObj(instance,objTypeDef,path,additionalProp){if(typeof objTypeDef=="object"){(typeof instance!="object"||instance instanceof Array)&&errors.push({property:path,message:"an object is required"});for(var i in objTypeDef)if(objTypeDef.hasOwnProperty(i)){var value=instance[i];if(value===undefined&&options.existingOnly)continue;var propDef=objTypeDef[i];value===undefined&&propDef["default"]&&(value=instance[i]=propDef["default"]),options.coerce&&i in instance&&(value=instance[i]=options.coerce(value,propDef)),checkProp(value,propDef,path,i)}}for(i in instance){if(instance.hasOwnProperty(i)&&(i.charAt(0)!="_"||i.charAt(1)!="_")&&objTypeDef&&!objTypeDef[i]&&additionalProp===!1){if(options.filter){delete instance[i];continue}errors.push({property:path,message:typeof value+"The property "+i+" is not defined in the schema and the schema does not allow additional properties"})}var requires=objTypeDef&&objTypeDef[i]&&objTypeDef[i].requires;requires&&!(requires in instance)&&errors.push({property:path,message:"the presence of the property "+i+" requires that "+requires+" also be present"}),value=instance[i],additionalProp&&(!objTypeDef||typeof objTypeDef!="object"||!(i in objTypeDef))&&(options.coerce&&(value=instance[i]=options.coerce(value,additionalProp)),checkProp(value,additionalProp,path,i)),!_changing&&value&&value.$schema&&(errors=errors.concat(checkProp(value,value.$schema,path,i)))}return errors}options||(options={});var _changing=options.changing,errors=[];return schema&&checkProp(instance,schema,"",_changing||""),!_changing&&instance&&instance.$schema&&checkProp(instance,instance.$schema,"",""),{valid:!errors.length,errors:errors}};return exports.mustBeValid=function(result){if(!result.valid)throw new TypeError(result.errors.map(function(error){return"for property "+error.property+": "+error.message}).join(", \n"))},exports}),define("lib/baseClient",["./sync","./store","./util","./validate"],function(sync,store,util,validate){function extractModuleName(path){if(path&&typeof path=="string"){var parts=path.split("/");if(parts.length>3&&parts[1]=="public")return parts[2];if(parts.length>2)return parts[1]}}function fireModuleEvent(eventName,moduleName,eventObj){var isPublic=isPublicRE.test(eventObj.path),events;moduleEvents[moduleName]&&(events=moduleEvents[moduleName][isPublic])&&(moduleName!=="root"&&eventObj.path&&(eventObj.relativePath=eventObj.path.replace((isPublic?"/public/":"/")+moduleName+"/","")),events.emit(eventName,eventObj))}function fireError(absPath,error){var isPublic=isPublicRE.test(absPath);moduleEvents[moduleName][isPublic].emit("error",error)}function set(path,absPath,value){var moduleName=extractModuleName(absPath);if(util.isDir(absPath)){fireError(absPath,"attempt to set a value to a directory "+absPath);return}var changeEvent={origin:"window",oldValue:store.getNodeData(absPath),newValue:value,path:absPath};store.setNodeData(absPath,value,!0),fireModuleEvent("change",moduleName,changeEvent),fireModuleEvent("change","root",changeEvent)}var logger=util.getLogger("baseClient"),moduleEvents={},isPublicRE=/^\/public\//;store.on("change",function(event){var moduleName=extractModuleName(event.path);fireModuleEvent("change",moduleName,event),fireModuleEvent("change","root",event)}),sync.on("conflict",function(event){var moduleName=extractModuleName(event.path);fireModuleEvent("conflict",moduleName,event),fireModuleEvent("conflict","root",event)});var BaseClient=function(moduleName,isPublic){this.moduleName=moduleName,this.isPublic=isPublic,moduleEvents[moduleName]||(moduleEvents[moduleName]={}),this.events=util.getEventEmitter("change","conflict","error"),moduleEvents[moduleName][isPublic]=this.events,util.bindAll(this)};return BaseClient.prototype={makePath:function(path){var base=this.moduleName=="root"?path[0]==="/"?"":"/":"/"+this.moduleName+"/";return(this.isPublic?"/public"+base:base)+path},nodeGivesAccess:function(path,mode){var node=store.getNode(path),access=(new RegExp(mode)).test(node.startAccess);if(access)return!0;if(path.length>0)return this.nodeGivesAccess(path.replace(/[^\/]+\/?$/,""))},ensureAccess:function(mode){var path=this.makePath(this.moduleName=="root"?"/":"");if(!this.nodeGivesAccess(path,mode))throw"Not sufficient access claimed for node at "+path},lastUpdateOf:function(path){var absPath=this.makePath(path),node=store.getNode(absPath);return node?node.timestamp:null},on:function(eventType,handler,context){this.events.on(eventType,util.bind(handler,context))},getObject:function(path,callback,context){this.ensureAccess("r");var absPath=this.makePath(path),data=store.getNodeData(absPath);if(!callback)return data;var cb=util.bind(callback,context);!data||typeof data=="object"&&Object.keys(data).length==0?sync.syncOne(absPath,function(node,data){cb(data)}):cb(data)},getListing:function(path,callback,context){this.ensureAccess("r");var absPath=this.makePath(path);if(!callback){var node=store.getNode(absPath),data=store.getNodeData(absPath),arr=[];for(var i in data)arr.push(i);return arr}sync.fetchNow(absPath,function(err,node){var data=store.getNodeData(absPath),arr=[];for(var i in data)arr.push(i);util.bind(callback,context)(arr)})},getAll:function(type,path,callback,context){typeof path!="string"&&(path=type,callback=path,context=callback,type=null);var makeMap=function(listing){var o={};return listing.forEach(function(name){var item=this.getObject(path+name);if(!type||type==item["@type"].split("/").slice(-1)[0])o[path+name]=item},this),o}.bind(this);if(!callback)return makeMap(this.getListing(path));this.getListing(path,function(listing){util.bind(callback,context)(makeMap(listing))},this)},getDocument:function(path,callback,context){function makeResult(){var node=store.getNode(absPath);return node?{mimeType:node.mimeType,data:store.getNodeData(absPath)}:null}this.ensureAccess("r");var absPath=this.makePath(path),result=makeResult();if(!callback)return result;var cb=util.bind(callback,context);result?cb(result):sync.syncOne(absPath,function(){cb(makeResult())})},remove:function(path,callback,context){this.ensureAccess("w");var absPath=this.makePath(path);set(path,absPath,undefined),sync.syncOne(absPath,util.bind(callback,context))},storeObject:function(type,path,obj,callback,context){this.ensureAccess("w");if(typeof obj!="object")throw"storeObject needs to get an object as value!";obj["@type"]=this.resolveType(type);var errors=this.validateObject(obj);if(errors)return console.error("Error saving this ",type,": ",obj,errors),errors;var absPath=this.makePath(path);return set(path,absPath,obj,"application/json"),sync.syncOne(absPath,util.bind(callback,context)),null},storeDocument:function(mimeType,path,data,callback,context){this.ensureAccess("w");var absPath=this.makePath(path);set(path,absPath,data,mimeType),sync.syncOne(absPath,util.bind(callback,context))},getStorageHref:function(){return remoteStorage.getStorageHref()},getItemURL:function(path){var base=this.getStorageHref();return base?(base.substr(-1)!="/"&&(base+="/"),base+this.makePath(path)):null},syncOnce:function(path,callback){var previousTreeForce=store.getNode(path).startForceTree;this.use(path,!1),sync.partialSync(path,1,function(){previousTreeForce?this.use(path,!0):this.release(path),callback&&callback()}.bind(this))},use:function(path,treeOnly){var absPath=this.makePath(path);store.setNodeForce(absPath,!treeOnly,!0)},release:function(path){var absPath=this.makePath(path);store.setNodeForce(absPath,!1,!1)},hasDiff:function(path){var absPath=this.makePath(path);if(util.isDir(absPath))return Object.keys(store.getNode(absPath).diff).length>0;var parentPath=util.containingDir(absPath);return!!store.getNode(parentPath).diff[path.split("/").slice(-1)[0]]},types:{},schemas:{},resolveType:function(alias){var type=this.types[alias];return type||(type="https://remotestoragejs.com/spec/modules/"+this.moduleName+"/"+alias,logger.error("WARNING: type alias not declared: "+alias,"(have:",this.types,this.schemas,")")),type},resolveSchema:function(type){var schema=this.schemas[type];return schema||(schema={},logger.error("WARNING: can't find schema for type: ",type)),schema},declareType:function(alias,type,schema){this.types[alias]&&logger.error("WARNING: re-declaring already declared alias "+alias),schema||(schema=type,type="https://remotestoragejs.com/spec/modules/"+this.moduleName+"/"+alias),this.types[alias]=type,this.schemas[type]=schema},validateObject:function(object,alias){var type=object["@type"];if(!type){if(!alias)return[{property:"@type",message:"missing"}];type=this.resolveType(alias)}var schema=this.resolveSchema(type),result=validate(object,schema);return result.valid?null:result.errors}},BaseClient}),define("lib/foreignClient",["./util","./baseClient","./getputdelete","./store"],function(util,BaseClient,getputdelete,store){var logger=util.getLogger("foreignClient"),knownClients={};store.on("foreign-change",function(event){var userAddress=event.path.split(":")[0],client=knownClients[userAddress];client&&client.events.emit("change",event)});var ForeignClient=function(userAddress){this.userAddress=userAddress,this.pathPrefix=userAddress+":",this.moduleName="root",this.isPublic=!0,this.events=util.getEventEmitter("change","error"),knownClients[userAddress]=this,util.bindAll(this)};ForeignClient.prototype={getPublished:function(moduleName,callback){var fullPath;typeof moduleName=="function"?(callback=moduleName,fullPath="/publishedItems"):fullPath="/"+moduleName+"/publishedItems",this.getObject(fullPath,function(data){data&&delete data["@type"],callback(data||{})})},getPublishedObjects:function(moduleName,callback){this.getPublished(moduleName,function(list){function loadOne(){if(i<paths.length){var key=paths[i++],path="/"+moduleName+"/"+key;this.getObject(path,function(object){objects[path]=object,loadOne.call(this)}.bind(this))}else callback(objects)}var paths=Object.keys(list),i=0,objects={};loadOne.call(this)}.bind(this))},makePath:function(path){return this.pathPrefix+BaseClient.prototype.makePath.call(this,path)},nodeGivesAccess:function(path,mode){return mode=="r"},on:function(eventName,handler){this.events.on(eventName,handler)}};var methodBlacklist={makePath:!0,getListing:!0,getAll:!0,storeDocument:!0,storeObject:!0,remove:!0,nodeGivesAccess:!0,fetchNow:!0,syncNow:!0,on:!0};for(var key in BaseClient.prototype)methodBlacklist[key]||(ForeignClient.prototype[key]=BaseClient.prototype[key]);return{getClient:function(userAddress){var client=knownClients[userAddress];return client||new ForeignClient(userAddress)}}}),define("remoteStorage",["require","./lib/widget","./lib/store","./lib/sync","./lib/wireClient","./lib/nodeConnect","./lib/util","./lib/webfinger","./lib/foreignClient","./lib/baseClient"],function(require,widget,store,sync,wireClient,nodeConnect,util,webfinger,foreignClient,BaseClient){var claimedModules={},modules={},moduleNameRE=/^[a-z]+$/,logger=util.getLogger("base"),remoteStorage={defineModule:function(moduleName,builder){if(!moduleNameRE.test(moduleName))throw'Invalid moduleName: "'+moduleName+'", only a-z lowercase allowed.';var module=builder(new BaseClient(moduleName,!1),new BaseClient(moduleName,!0));modules[moduleName]=module,this[moduleName]=module.exports},getModuleList:function(){return Object.keys(modules)},getClaimedModuleList:function(){return Object.keys(claimedModules)},getModuleInfo:function(moduleName){return modules[moduleName]},claimAccess:function(moduleName,mode){function testMode(moduleName,mode){if(!modeTestRegex.test(mode))throw"Claimed access to module '"+moduleName+"' but mode not correctly specified ('"+mode+"')."}var modeTestRegex=/^rw?$/,moduleObj;typeof moduleName=="object"?moduleObj=moduleName:(testMode(moduleName,mode),moduleObj={},moduleObj[moduleName]=mode);for(var _moduleName in moduleObj){var _mode=moduleObj[_moduleName];testMode(_moduleName,_mode),this.claimModuleAccess(_moduleName,_mode)}},claimModuleAccess:function(moduleName,mode){logger.debug("claimModuleAccess",moduleName,mode);if(!(moduleName in modules))throw"Module not defined: "+moduleName;if(moduleName in claimedModules)return;moduleName=="root"?(moduleName="",widget.addScope("",mode),store.setNodeAccess("/",mode)):(widget.addScope(moduleName,mode),store.setNodeAccess("/"+moduleName+"/",mode),store.setNodeAccess("/public/"+moduleName+"/",mode)),claimedModules[moduleName]=!0},setBearerToken:function(bearerToken,claimedScopes){wireClient.setBearerToken(bearerToken)},disconnectRemote:wireClient.disconnectRemote,flushLocal:store.forgetAll,syncNow:function(path,depth,callback){depth||(callback=depth,depth=null),sync.partialSync(path,depth,callback)},displayWidget:widget.display,onWidget:widget.on,getWidgetState:widget.getState,getSyncState:sync.getState,setStorageInfo:wireClient.setStorageInfo,getStorageHref:wireClient.getStorageHref,disableSyncThrottling:sync.disableThrottling,nodeConnect:nodeConnect,util:util,getForeignClient:function(userAddress,callback){var client=foreignClient.getClient(userAddress);wireClient.hasStorageInfo(userAddress)?callback(null,client):webfinger.getStorageInfo(userAddress,{timeout:5e3},function(err,storageInfo){err?callback(err):(wireClient.addStorageInfo(userAddress,storageInfo),callback(null,client))})},getClient:function(scope){return new BaseClient(scope)}};return remoteStorage}),define("modules/root",["../remoteStorage"],function(remoteStorage){return window.rootRemoteStorage=remoteStorage,remoteStorage.defineModule("public",function(client){function getPublicItems(){return client.getObject("publishedItems")}return{exports:{getPublicItems:getPublicItems,getObject:client.getObject}}}),remoteStorage.defineModule("root",function(myPrivateBaseClient,myPublicBaseClient){function setOnChange(cb){myPrivateBaseClient.on("change",cb),myPublicBaseClient.on("change",cb)}function addToPublicItems(path){var data=myPublicBaseClient.getObject("publishedItems");path[0]=="/"&&(path=path.substr(1)),data?data.indexOf(path)==-1&&data.unshift(path):(data=[],data.push(path)),myPublicBaseClient.storeObject("array","publishedItems",data)}function removeFromPublicItems(path){var data=myPublicBaseClient.getObject("publishedItems");path[0]=="/"&&(path=path.substr(1)),data?data.indexOf(path)!=-1&&data.pop(path):data=[],myPublicBaseClient.storeObject("array","publishedItems",data)}function publishObject(path){if(pathIsPublic(path))return"Object has already been made public";var data=myPrivateBaseClient.getObject(path),publicPath="/public"+path;return addToPublicItems(publicPath),myPrivateBaseClient.remove(path),myPrivateBaseClient.storeObject(data["@type"],publicPath,data),"Object "+path+" has been published to "+publicPath}function archiveObject(path){if(!pathIsPublic(path))return"Object has already been made private";var data=myPrivateBaseClient.getObject(path),privatePath=path.substring(7,path.length);return removeFromPublicItems(path),myPrivateBaseClient.remove(path),myPrivateBaseClient.storeObject(data["@type"],privatePath,data),"Object "+path+" has been archived to "+privatePath}function pathIsPublic(path){return path.substring(0,8)=="/public/"?!0:!1}function getClient(path){return pathIsPublic(path)?myPublicBaseClient:myPrivateBaseClient}function hasDiff(path){var client=getClient(path);return client.hasDiff(path)}function getObject(path,cb,context){var client=getClient(path);return client.getObject(path,cb,context)}function getDocument(path,cb,context){var client=getClient(path);return client.getDocument(path,cb,context)}function setDocument(mimeType,path,data,cb,context){var client=getClient(path);return client.storeDocument(mimeType,path,data,cb,context)}function setObject(type,path,obj){var client=getClient(path);typeof obj=="object"?client.storeObject(type,path,obj):client.storeDocument(type,path,obj)}function removeObject(path){var client=getClient(path);client.remove(path)}function getListing(path,cb,context){if(!path)throw"Path is required";var client=getClient(path);return client.getListing(path,cb,context)}function on(eventName,callback){myPrivateBaseClient.on(eventName,callback),myPublicBaseClient.on(eventName,callback)}return{exports:{on:on,use:function(){myPrivateBaseClient.use.apply(myPrivateBaseClient,arguments)},release:function(){myPrivateBaseClient.release.apply(myPrivateBaseClient,arguments)},getListing:getListing,getObject:getObject,setObject:setObject,getDocument:getDocument,setDocument:setDocument,removeObject:removeObject,archiveObject:archiveObject,publishObject:publishObject,setOnChange:setOnChange,hasDiff:hasDiff,syncOnce:myPrivateBaseClient.syncOnce.bind(myPrivateBaseClient)}}}),remoteStorage.root}),define("modules/calendar",["../remoteStorage"],function(remoteStorage){var moduleName="calendar";return remoteStorage.defineModule(moduleName,function(client){function getEventsForDay(day){var ids=client.getListing(day+"/"),list=[];for(var i=0;i<ids.length;i++){var obj=client.getObject(day+"/"+ids[i]);list.push({itemId:ids[i],itemValue:obj.summary})}return list}function addEvent(itemId,day,value){var mdy=day.split("_");client.storeObject("event",day+"/"+itemId,{summary:value,dtstart:(new Date(mdy[2],mdy[0],mdy[1])).toISOString()})}function removeEvent(itemId,day){client.remove(day+"/"+itemId)}return client.declareType("event",{description:"A representation of an event",type:"object",properties:{dtstart:{format:"date-time",type:"string",description:"Event starting time",required:!0},dtend:{format:"date-time",type:"string",description:"Event ending time"},summary:{type:"string",required:!0},location:{type:"string"},url:{type:"string",format:"uri"},duration:{format:"time",type:"string",description:"Event duration"},rdate:{format:"date-time",type:"string",description:"Recurrence date"},rrule:{type:"string",description:"Recurrence rule"},category:{type:"string"},description:{type:"string"},geo:{$ref:"http: //json-schema.org/geo"}}}),client.use(""),{exports:{getEventsForDay:getEventsForDay,addEvent:addEvent,removeEvent:removeEvent}}}),remoteStorage[moduleName]}),define("modules/deps/vcardjs-0.2",[],function(){(function(){var CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(len,radix){var chars=CHARS,uuid=[],i;radix=radix||chars.length;if(len)for(i=0;i<len;i++)uuid[i]=chars[0|Math.random()*radix];else{var r;uuid[8]=uuid[13]=uuid[18]=uuid[23]="-",uuid[14]="4";for(i=0;i<36;i++)uuid[i]||(r=0|Math.random()*16,uuid[i]=chars[i==19?r&3|8:r])}return uuid.join("")},Math.uuidFast=function(){var chars=CHARS,uuid=new Array(36),rnd=0,r;for(var i=0;i<36;i++)i==8||i==13||i==18||i==23?uuid[i]="-":i==14?uuid[i]="4":(rnd<=2&&(rnd=33554432+Math.random()*16777216|0),r=rnd&15,rnd>>=4,uuid[i]=chars[i==19?r&3|8:r]);return uuid.join("")},Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)})}})();var VCard;(function(){VCard=function(attributes){this.changed=!1;if(typeof attributes=="object")for(var key in attributes)this[key]=attributes[key],this.changed=!0},VCard.prototype={validate:function(){function addError(attribute,type){errors.push([attribute,type])}function validateCompoundWithType(attribute,values){for(var i in values){var value=values[i];typeof value!="object"?errors.push([attribute+"-"+i,"not-an-object"]):value.type?value.value||errors.push([attribute+"-"+i,"missing-value"]):errors.push([attribute+"-"+i,"missing-type"])}}var errors=[];this.fn||addError("fn","required");for(var key in VCard.multivaluedKeys)this[key]&&!(this[key]instanceof Array)&&(this[key]=[this[key]]);return this.email&&validateCompoundWithType("email",this.email),this.tel&&validateCompoundWithType("email",this.tel),this.uid||this.addAttribute("uid",this.generateUID()),this.rev||this.addAttribute("rev",this.generateRev()),this.errors=errors,!(errors.length>0)},generateUID:function(){return"uuid:"+Math.uuid()},generateRev:function(){return(new Date).toISOString().replace(/[\.\:\-]/g,"")},setAttribute:function(key,value){this[key]=value,this.changed=!0},addAttribute:function(key,value){console.log("add attribute",key,value);if(!value)return;VCard.multivaluedKeys[key]?this[key]?(console.log("multivalued push"),this[key].push(value)):(console.log("multivalued set"),this.setAttribute(key,[value])):this.setAttribute(key,value)},toJSON:function(){return JSON.stringify(this.toJCard())},toJCard:function(){var jcard={};for(var k in VCard.allKeys){var key=VCard.allKeys[k];this[key]&&(jcard[key]=this[key])}return jcard},merge:function(other){function mergeProperty(key){other[key]?other[key]==this[key]?result.setAttribute(this[key]):(result.addAttribute(this[key]),result.addAttribute(other[key])):result[key]=this[key]}if(typeof other.uid!="undefined"&&typeof this.uid!="undefined"&&other.uid!==this.uid)throw"Won't merge vcards without matching UIDs.";var result=new VCard;for(key in this)mergeProperty(key);for(key in other)result[key]||mergeProperty(key)}},VCard.enums={telType:["text","voice","fax","cell","video","pager","textphone"],relatedType:["contact","acquaintance","friend","met","co-worker","colleague","co-resident","neighbor","child","parent","sibling","spouse","kin","muse","crush","date","sweetheart","me","agent","emergency"],emailType:["work","home","internet"],langType:["work","home"]},VCard.allKeys=["fn","n","nickname","photo","bday","anniversary","gender","tel","email","impp","lang","tz","geo","title","role","logo","org","member","related","categories","note","prodid","rev","sound","uid"],VCard.multivaluedKeys={email:!0,tel:!0,geo:!0,title:!0,role:!0,logo:!0,org:!0,member:!0,related:!0,categories:!0,note:!0}})();var VCF;return function(){VCF={simpleKeys:["VERSION","FN","PHOTO","GEO","TITLE","ROLE","LOGO","MEMBER","NOTE","PRODID","SOUND","UID"],csvKeys:["NICKNAME","CATEGORIES"],dateAndOrTimeKeys:["BDAY","ANNIVERSARY","REV"],parse:function(input,callback,context){var vcard=null;context||(context=this),this.lex(input,function(key,value,attrs){function setAttr(val){vcard&&vcard.addAttribute(key.toLowerCase(),val)}if(key=="BEGIN")vcard=new VCard;else if(key=="END")vcard&&(callback.apply(context,[vcard]),vcard=null);else if(this.simpleKeys.indexOf(key)!=-1)setAttr(value);else if(this.csvKeys.indexOf(key)!=-1)setAttr(value.split(","));else if(this.dateAndOrTimeKeys.indexOf(key)!=-1)attrs.VALUE=="text"?setAttr(value):(!attrs.CALSCALE||attrs.CALSCALE=="gregorian")&&setAttr(this.parseDateAndOrTime(value));else if(key=="N")setAttr(this.parseName(value));else if(key=="GENDER")setAttr(this.parseGender(value));else if(key=="TEL")setAttr({type:attrs.TYPE||"voice",pref:attrs.PREF,value:value});else if(key=="EMAIL")setAttr({type:attrs.TYPE,pref:attrs.PREF,value:value});else if(key=="IMPP")setAttr({value:value});else if(key=="LANG")setAttr({type:attrs.TYPE,pref:attrs.PREF,value:value});else if(key=="TZ")attrs.VALUE=="utc-offset"?setAttr({"utc-offset":this.parseTimezone(value)}):setAttr({name:value});else if(key=="ORG"){var parts=value.split(";");setAttr({"organization-name":parts[0],"organization-unit":parts[1]})}else key=="RELATED"?setAttr({type:attrs.TYPE,pref:attrs.PREF,value:attrs.VALUE}):console.log("WARNING: unhandled key: ",key)})},nameParts:["family-name","given-name","additional-name","honorific-prefix","honorific-suffix"],parseName:function(name){var parts=name.split(";"),n={};for(var i in parts)parts[i]&&(n[this.nameParts[i]]=parts[i].split(","));return n},parseGender:function(value){var gender={},parts=value.split(";");switch(parts[0]){case"M":gender.sex="male";break;case"F":gender.sex="female";break;case"O":gender.sex="other"}return parts[1]&&(gender.identity=parts[1]),gender},dateRE:/^(\d{4})(\d{2})(\d{2})$/,dateReducedARE:/^(\d{4})\-(\d{2})$/,dateReducedBRE:/^(\d{4})$/,dateTruncatedMDRE:/^\-{2}(\d{2})(\d{2})$/,dateTruncatedDRE:/^\-{3}(\d{2})$/,timeRE:/^(\d{2})(\d{2})(\d{2})([+\-]\d+|Z|)$/,timeReducedARE:/^(\d{2})(\d{2})([+\-]\d+|Z|)$/,timeReducedBRE:/^(\d{2})([+\-]\d+|Z|)$/,timeTruncatedMSRE:/^\-{2}(\d{2})(\d{2})([+\-]\d+|Z|)$/,timeTruncatedSRE:/^\-{3}(\d{2})([+\-]\d+|Z|)$/,parseDate:function(data){var md,y,m,d;if(md=data.match(this.dateRE))y=md[1],m=md[2],d=md[3];else if(md=data.match(this.dateReducedARE))y=md[1],m=md[2];else if(md=data.match(this.dateReducedBRE))y=md[1];else if(md=data.match(this.dateTruncatedMDRE))m=md[1],d=md[2];else{if(!(md=data.match(this.dateTruncatedDRE)))return console.error("WARNING: failed to parse date: ",data),null;d=md[1]}var dt=new Date(0);return typeof y!="undefined"&&dt.setUTCFullYear(y),typeof m!="undefined"&&dt.setUTCMonth(m-1),typeof d!="undefined"&&dt.setUTCDate(d),dt},parseTime:function(data){var md,h,m,s,tz;if(md=data.match(this.timeRE))h=md[1],m=md[2],s=md[3],tz=md[4];else if(md=data.match(this.timeReducedARE))h=md[1],m=md[2],tz=md[3];else if(md=data.match(this.timeReducedBRE))h=md[1],tz=md[2];else if(md=data.match(this.timeTruncatedMSRE))m=md[1],s=md[2],tz=md[3];else{if(!(md=data.match(this.timeTruncatedSRE)))return console.error("WARNING: failed to parse time: ",data),null;s=md[1],tz=md[2]}var dt=new Date(0);return typeof h!="undefined"&&dt.setUTCHours(h),typeof m!="undefined"&&dt.setUTCMinutes(m),typeof s!="undefined"&&dt.setUTCSeconds(s),tz&&(dt=this.applyTimezone(dt,tz)),dt},addDates:function(aDate,bDate,addSub){typeof addSub=="undefined"&&(addSub=!0);if(!aDate)return bDate;if(!bDate)return aDate;var a=Number(aDate),b=Number(bDate),c=addSub?a+b:a-b;return new Date(c)},parseTimezone:function(tz){var md;if(md=tz.match(/^([+\-])(\d{2})(\d{2})?/)){var offset=new Date(0);return offset.setUTCHours(md[2]),offset.setUTCMinutes(md[3]||0),Number(offset)*(md[1]=="+"?1:-1)}return null},applyTimezone:function(date,tz){var offset=this.parseTimezone(tz);return offset?new Date(Number(date)+offset):date},parseDateTime:function(data){var parts=data.split("T"),t=this.parseDate(parts[0]),d=this.parseTime(parts[1]);return this.addDates(t,d)},parseDateAndOrTime:function(data){switch(data.indexOf("T")){case 0:return this.parseTime(data.slice(1));case-1:return this.parseDate(data);default:return this.parseDateTime(data)}},lineRE:/^([^\s].*)(?:\r?\n|$)/,foldedLineRE:/^\s(.+)(?:\r?\n|$)/,lex:function(input,callback){var md,line=null,length=0;for(;;){(md=input.match(this.lineRE))?(line&&this.lexLine(line,callback),line=md[1],length=md[0].length):(md=input.match(this.foldedLineRE))?line&&(line+=md[1],length=md[0].length):console.error("Unmatched line: "+line),input=input.slice(length);if(!input)break}line&&this.lexLine(line,callback),line=null},lexLine:function(line,callback){function finalizeKeyOrAttr(){if(key){if(!attrKey){console.error("Invalid attribute: ",tmp,"Line dropped.");return}attrs[attrKey]=tmp}else key=tmp}var tmp="",key=null,attrs={},value=null,attrKey=null;for(var i in line){var c=line[i];switch(c){case":":finalizeKeyOrAttr(),value=line.slice(Number(i)+1),callback.apply(this,[key,value,attrs]);return;case";":finalizeKeyOrAttr(),tmp="";break;case"=":attrKey=tmp,tmp="";break;default:tmp+=c}}}}}(),{VCard:VCard,VCF:VCF}}),define("modules/contacts",["../remoteStorage","../modules/deps/vcardjs-0.2"],function(remoteStorage,vCardJS){var moduleName="contacts",VCard=vCardJS.VCard,VCF=vCardJS.VCF;return remoteStorage.defineModule(moduleName,function(base){function extend(){var destination=arguments[0],source;for(var i=1;i<arguments.length;i++){source=arguments[i];var keys=Object.keys(source);for(var j=0;j<keys.length;j++){var key=keys[j];destination[key]=source[key]}}return destination}function makeVcardInstance(data){var type=data.kind=="individual"?Contact:data.kind=="group"?Group:VCard;return new type(data)}var DEBUG=!0,contacts={},bindContext=typeof function(){}.bind=="function"?function(cb,context){return cb.bind(context)}:function(cb,context){return function(){return cb.apply(context,arguments)}},debug=DEBUG?bindContext(console.log,console):function(){},Contact=function(){VCard.apply(this,arguments),this.setAttribute("kind","individual")},Group=function(name){VCard.apply(this,arguments),this.setAttribute("kind","group")},groupMembers={getMembers:function(){var members=[];for(var i=0;i<this.member.length;i++)members.push(this.lookupMember(member[i]));return members},lookupMember:function(uri){var md=uri.match(/^([^:]):(.*)$/),scheme=md[1],rest=md[2],key;switch(scheme){case"urn":case"uuid":return contacts.get(uri);case"mailto":case"xmpp":case"sip":case"tel":var query={};query[{mailto:"email",xmpp:"impp",sip:"impp",tel:"tel"}[scheme]]=rest;var results=contacts.search(query);if(results.length>0)return results[0];if(scheme=="tel")break;case"acct":console.error("FIXME: implement contact-lookup via webfinger!");break;case"http":console.error("FIXME: implement contact-lookup via HTTP!");break;default:console.error("FIXME: unknown URI scheme "+scheme)}return undefined}};return extend(contacts,{Contact:Contact,Group:Group,on:function(eventType,callback){base.on(eventType,function(event){event.oldValue&&(event.oldValue=contacts._wrap(event.oldValue)),event.newValue&&(event.newValue=contacts._wrap(event.newValue)),callback(event)})},use:function(){debug("contacts.sync()"),base.use("")},list:function(limit,offset){var list=base.getListing("");offset||(offset=0),limit||(limit=list.length-offset);for(var i=0;i<limit;i++)list[i+offset]&&(list[i+offset]=this.get(list[i+offset]));return list},get:function(uid,cb,context){if(!cb)return this._wrap(base.getObject(uid));base.getObject(uid,function(data){bindContext(cb,context)(this._wrap(data))},this)},build:function(attributes){return this._wrap(attributes)},put:function(contact){var contact=this.build(contact);return contact.validate(),base.storeObject("vcard+"+(contact.kind||"individual"),contact.uid,contact.attributes),contact},filter:function(cb,context){var list=this.list(),results=[],item;for(var i=0;i<list.length;i++)item=bindContext(cb,context)(list[i]),item&&results.push(item);return results},search:function(filter){var keys=Object.keys(filter);return this.filter(function(item){return this.searchMatch(item,filter,keys)},this)},searchMatch:function(item,filter,filterKeys){filterKeys||(filterKeys=Object.keys(filter));var check=function(value,ref){if(value instanceof Array)for(var i=0;i<value.length;i++)check(value[i],ref);else if(typeof value=="object"&&value.value)check(value.value,ref);else{if(typeof ref=="string"&&ref.length===0)return!0;if(ref instanceof RegExp){if(!ref.test(value))return!1}else if(value!==ref)return!1}};return this.filter(function(item){for(var i=0;i<keys.length;i++){var k=keys[i],v=filter[k];if(!check(item[k],v))return!1}return debug("success"),item})},_wrap:function(data){return data instanceof VCard?data:makeVcardInstance(data)}}),{name:moduleName,dataHints:{},exports:contacts}}),remoteStorage[moduleName]}),define("modules/documents",["../remoteStorage"],function(remoteStorage){var moduleName="documents";return remoteStorage.defineModule(moduleName,function(myBaseClient){function fire(eventType,eventObj){if(eventType=="error")for(var i=0;i<errorHandlers.length;i++)errorHandlers[i](eventObj)}function getUuid(){var uuid="",i,random;for(i=0;i<32;i++){random=Math.random()*16|0;if(i===8||i===12||i===16||i===20)uuid+="-";uuid+=(i===12?4:i===16?random&3|8:random).toString(16)}return uuid}function getPrivateList(listName){function getIds(){return myBaseClient.getListing(listName+"/")}function getContent(id){var obj=myBaseClient.getObject(listName+"/"+id);return obj?obj.content:""}function getTitle(id){return getContent(id).slice(0,50)}function setContent(id,content){content==""?myBaseClient.remove(listName+"/"+id):myBaseClient.storeObject("text",listName+"/"+id,{content:content})}function add(content){var id=getUuid();return myBaseClient.storeObject("text",listName+"/"+id,{content:content}),id}function on(eventType,cb){myBaseClient.on(eventType,cb),eventType=="error"&&errorHandlers.push(cb)}return myBaseClient.use(listName+"/"),{getIds:getIds,getContent:getContent,getTitle:getTitle,setContent:setContent,add:add,on:on}}var errorHandlers=[];return{name:moduleName,dataHints:{module:"documents can be text documents, or etherpad-lite documents or pdfs or whatever people consider a (text) document. But spreadsheets and diagrams probably not","objectType text":"a human-readable plain-text document in utf-8. No html or markdown etc, they should have their own object types","string text#content":"the content of the text document","directory documents/notes/":"used by litewrite for quick notes","item documents/notes/calendar":"used by docrastinate for the 'calendar' pane","item documents/notes/projects":"used by docrastinate for the 'projects' pane","item documents/notes/personal":"used by docrastinate for the 'personal' pane"},exports:{getPrivateList:getPrivateList}}}),remoteStorage[moduleName]}),define("modules/money",["../remoteStorage"],function(remoteStorage){remoteStorage.defineModule("money",function(myPrivateBaseClient,myPublicBaseClient){return{name:"money",dataHints:{},exports:{setDayBusiness:function(tab,year,month,day,transactions,endBalances){var datePath=year+"/"+month+"/"+day+"/"+tab.substring(1)+"/";for(var i=0;i<transactions.length;i++)myPrivateBaseClient.storeObject("transaction",datePath+"transaction/"+i,transactions[i]);for(var i in endBalances)myPrivateBaseClient.storeObject("balance",datePath+"balance/"+i,endBalances[i])}}}})}),define("modules/tasks",["../remoteStorage"],function(remoteStorage){var moduleName="tasks";return remoteStorage.defineModule(moduleName,function(myPrivateBaseClient,myPublicBaseClient){function fire(eventType,eventObj){if(eventType=="error")for(var i=0;i<errorHandlers.length;i++)errorHandlers[i](eventObj)}function getUuid(){var uuid="",i,random;for(i=0;i<32;i++){random=Math.random()*16|0;if(i===8||i===12||i===16||i===20)uuid+="-";uuid+=(i===12?4:i===16?random&3|8:random).toString(16)}return uuid}function getPrivateList(listName){function getIds(){return myPrivateBaseClient.getListing(listName+"/")}function get(id){return myPrivateBaseClient.getObject(listName+"/"+id)}function set(id,title){var obj=myPrivateBaseClient.getObject(listName+"/"+id);obj.title=title,myPrivateBaseClient.storeObject("task",listName+"/"+id,obj)}function add(title){var id=getUuid();return myPrivateBaseClient.storeObject("task",listName+"/"+id,{title:title,completed:!1}),id}function markCompleted(id,completedVal){typeof completedVal=="undefined"&&(completedVal=!0);var obj=myPrivateBaseClient.getObject(listName+"/"+id);obj&&obj.completed!=completedVal&&(obj.completed=completedVal,myPrivateBaseClient.storeObject("task",listName+"/"+id,obj))}function isCompleted(id){var obj=get(id);return obj&&obj.completed}function getStats(){var ids=getIds(),stat={todoCompleted:0,totalTodo:ids.length};for(var i=0;i<stat.totalTodo;i++)isCompleted(ids[i])&&(stat.todoCompleted+=1);return stat.todoLeft=stat.totalTodo-stat.todoCompleted,stat}function remove(id){myPrivateBaseClient.remove(listName+"/"+id)}function on(eventType,cb){myPrivateBaseClient.on(eventType,cb),eventType=="error"&&errorHandlers.push(cb)}return myPrivateBaseClient.use(listName+"/"),{getIds:getIds,get:get,set:set,add:add,remove:remove,markCompleted:markCompleted,getStats:getStats,on:on}}var errorHandlers=[];return{name:moduleName,dataHints:{module:"","objectType task":"something that needs doing, like cleaning the windows or fixing a specific bug in a program","string task#title":"describes what it is that needs doing","boolean task#completed":"whether the task has already been completed or not (yet)","directory tasks/todos/":"default private todo list","directory tasks/:year/":"tasks that need doing during year :year","directory public/tasks/:hash/":"tasks list shared to for instance a team"},exports:{getPrivateList:getPrivateList}}}),remoteStorage[moduleName]}),define("modules/bookmarks",["../remoteStorage"],function(remoteStorage){var moduleName="bookmarks";remoteStorage.defineModule(moduleName,function(privateClient,publicClient){return{name:moduleName,dataHints:{module:"Store URLs which you do not wish to forget"},exports:{on:privateClient.on,listUrls:function(){var keys=privateClient.getListing(""),urls=[];return keys.forEach(function(key){urls.push(privateClient.getObject(key).url)}),urls},listBookmarks:function(){var keys=privateClient.getListing(""),bms=[];return keys.forEach(function(key){bms.push(privateClient.getObject(key))}),privateClient.use(""),bms},addUrl:function(url){return privateClient.storeObject("bookmark",encodeURIComponent(url),{url:url,createdAt:new Date})},getPublicListing:function(){var listing=publicClient.getObject("publishedItems");return listing||{items:[]}},publish:function(url){var key=encodeURIComponent(url),bookmark=privateClient.getObject(key);publicClient.storeObject("bookmark",key,bookmark);var listing=publicClient.getListing("");delete listing.published,publicClient.storeObject("bookmark-list","published",listing)}}}})}),define("remoteStorage-modules",["./remoteStorage","./modules/root","./modules/calendar","./modules/contacts","./modules/documents","./modules/money","./modules/tasks","./modules/bookmarks"],function(remoteStorage){return remoteStorage}),remoteStorage=require("remoteStorage-modules")})()