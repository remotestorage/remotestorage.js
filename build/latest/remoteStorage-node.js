(function(){function c(c,d,e){a[c]=e;var f=c.substring(0,c.lastIndexOf("/")+1);b[c]=[];for(var g=0;g<d.length;g++)d[g].substring(0,2)=="./"&&(d[g]=d[g].substring(2)),b[c].push(f+d[g])}function d(c){if(c=="require")return function(){};var e=b[c],f={};for(var g=0;g<e.length;g++)f[e[g]]=d(e[g]);var h=[];for(var g=0;g<e.length;g++)h.push(f[e[g]]);return a[c].apply({},h)}var a={},b={};c("lib/platform",[],function(){function a(a){var b=!1,c;a.timeout&&(c=window.setTimeout(function(){b=!0,a.error("timeout")},a.timeout));var d=new XMLHttpRequest;a.method||(a.method="GET"),a.data||(a.data=null),d.open(a.method,a.url,!0);if(a.headers)for(var e in a.headers)d.setRequestHeader(e,a.headers[e]);d.onreadystatechange=function(){d.readyState==4&&!b&&(c&&window.clearTimeout(c),d.status==200||d.status==201||d.status==204?a.success(d.responseText):a.error(d.status))},d.send(a.data)}function b(a){a.error("not implemented")}function c(a){console.log(a),a.error("not implemented")}function d(a){return(new DOMParser).parseFromString(a,"text/xml")}return typeof window=="undefined"?{ajax:c,parseXml:d}:window.XDomainRequest?{ajax:b,parseXml:d}:{ajax:a,parseXml:d}}),c("lib/couch",["./platform"],function(a){function c(a){if(!b){try{b=JSON.parse(localStorage.getItem("_shadowCouchRev"))}catch(c){}b||(b={})}return b[a]}function d(a,c){if(!b)try{b=JSON.parse(localStorage.getItem("_shadowCouchRev"))}catch(d){b={}}b[a]=c,localStorage.setItem("_shadowCouchRev",JSON.stringify(b))}function e(a){var b=0;while(b<a.length&&a[b]=="u")b++;return b<a.length&&a[b]=="_"&&(a="u"+a),a}function f(b,c,d,e,f){var g={url:c,method:b,error:function(a){a==404?f(null,undefined):f(a,null)},success:function(a){f(null,a)},timeout:3e3};e&&(g.headers={Authorization:"Bearer "+e}),g.fields={withCredentials:"true"},b!="GET"&&(g.data=d),a.ajax(g)}function g(a,b,c,g){f("GET",a+e(c),null,b,function(a,b){if(a)g(a,b);else{var e;try{e=JSON.parse(b)}catch(f){}e&&e._rev?(d(c,e._rev),g(null,e.value)):typeof b=="undefined"?g(null,undefined):g("unparsable data from couch")}})}function h(a,b,g,h,i){var j=c(g),k={value:h};j&&(k._rev=j),f("PUT",a+e(g),JSON.stringify(k),b,function(c,j){if(c)c==409?f("GET",a+e(g),null,b,function(c,j){if(c)i("after 409, got a "+c);else{var l;try{l=JSON.parse(j)._rev}catch(m){}l?(k={value:h,_rev:l},d(g,l),f("PUT",a+e(g),JSON.stringify(k),b,function(a,b){a?i("after 409, second attempt got "+a):i(null)})):i("after 409, got unparseable JSON")}}):i(c);else{var k;try{k=JSON.parse(j)}catch(l){}k&&k.rev&&d(g,k.rev),i(null)}})}function i(a,b,g,h){var i=c(g);f("DELETE",a+e(g)+(i?"?rev="+i:""),null,b,function(c,i){c==409?f("GET",a+e(g),null,b,function(c,i){if(c)h("after 409, got a "+c);else{var j;try{j=JSON.parse(i)._rev}catch(k){}j?(d(g,j),f("DELETE",a+e(g)+"?rev="+j,null,b,function(a,b){a?h("after 409, second attempt got "+a):(d(g,undefined),h(null))})):h("after 409, got unparseable JSON")}}):(c||d(g,undefined),h(c))})}var b=null;return{get:g,put:h,"delete":i}}),c("lib/dav",["./platform"],function(a){function b(a){var b=0;while(b<a.length&&a[b]=="u")b++;return b<a.length&&a[b]=="_"&&(a="u"+a),a}function c(b,c,d,e,f,g){var h={url:c,method:b,error:function(a){a==404?f(null,undefined):f(a,null)},success:function(a){f(null,a)},timeout:3e3};h.headers={Authorization:"Bearer "+e,"Content-Type":"text/plain;charset=UTF-8"},h.fields={withCredentials:"true"},b!="GET"&&(h.data=d),a.ajax(h)}function d(a,d,e,f){c("GET",a+b(e),null,d,f)}function e(a,d,e,f,g){c("PUT",a+b(e),f,d,g)}function f(a,d,e,f){c("DELETE",a+b(e),null,d,f)}return{get:d,put:e,"delete":f}}),c("lib/webfinger",["./platform"],function(a){function b(a,b){var c=a.split("@");c.length<2?b("That is not a user address. There is no @-sign in it"):c.length>2?b("That is not a user address. There is more than one @-sign in it"):/^[\.0-9A-Za-z]+$/.test(c[0])?/^[\.0-9A-Za-z\-]+$/.test(c[1])?b(null,["https://"+c[1]+"/.well-known/host-meta.json","https://"+c[1]+"/.well-known/host-meta","http://"+c[1]+"/.well-known/host-meta.json","http://"+c[1]+"/.well-known/host-meta"]):b('That is not a user address. There are non-dotalphanumeric symbols after the @-sign: "'+c[1]+'"'):b('That is not a user address. There are non-dotalphanumeric symbols before the @-sign: "'+c[0]+'"')}function c(b,d,e){var f=b.shift();f?a.ajax({url:f,success:function(a){e(null,a)},error:function(a){c(b,d,e)},timeout:d}):e("could not fetch xrd")}function d(a,b){var c=[],d=a.getElementsByTagName(b);for(var e=0;e<d.length;e++){var f={};for(var g=0;g<d[e].attributes.length;g++){var h=d[e].attributes[g];f[h.name]=h.value}c.push(f)}return c}function e(a){return[]}function f(b){dataXml=a.parseXml(b);if(!dataXml.getElementsByTagName)try{return JSON.parse(b)}catch(c){return b}return{subject:d(dataXml,"Subject")[0],expires:d(dataXml,"Expires")[0],aliases:d(dataXml,"aliases"),properties:e(d(dataXml,"Property")),links:d(dataXml,"Link")}}function g(a,b){var c=f(a),d={};if(c&&c.links)for(var e=0;e<c.links.length;e++)d[c.links[e].rel]=c.links[e];return d}function h(a,d,e){b(a,function(b,f){b?e(err):c(f,d.timeout,function(b,f){if(b)e("could not fetch host-meta for "+a);else{var h=g(f);if(h.lrdd&&h.lrdd.template){var i=h.lrdd.template.split("{uri}"),j=[i.join("acct:"+a),i.join(a)];c(j,d.timeout,function(b,c){if(b)e("could not fetch lrdd for "+a);else{var d=g(c);d.remoteStorage?e(null,d.remoteStorage):e("could not extract storageInfo from lrdd")}})}else e("could not extract lrdd template from host-meta")}})})}function i(a,b){var c=a.split("{category}");return c.length!=2?"cannot-resolve-template:"+a:c[0]+b+c[1]}return{getStorageInfo:h,resolveTemplate:i}}),c("remoteStorage",["require","./lib/platform","./lib/couch","./lib/dav","./lib/webfinger"],function(a,b,c,d,e){var f=function(a,b){e.getStorageInfo(a,{timeout:3e3},b)},g=function(a,b,c){var d=["redirect_uri="+encodeURIComponent(c),"scope="+encodeURIComponent(b.join(",")),"response_type=token","client_id="+encodeURIComponent(c)];return a.auth+(a.auth.indexOf("?")===-1?"?":"&")+d.join("&")},h=function(a,b){b(a==="CouchDB"?c:d)},i=function(a,b,c){var d=e.resolveTemplate(a.template,b);return{get:function(b,e){h(a.api,function(a){a.get(d,c,b,e)})},put:function(b,e,f){h(a.api,function(a){a.put(d,c,b,e,f)})},"delete":function(b,e){h(a.api,function(a){a["delete"](d,c,b,e)})}}},j=function(){var a,b;if(location.hash.length>0){a=location.hash.split("&");for(var c=0;c<a.length;c++){a[c][0]=="#"&&(a[c]=a[c].substring(1));if(a[c].substring(0,"access_token=".length)=="access_token=")return a[c].substring("access_token=".length)}}return null};return{getStorageInfo:f,createOAuthAddress:g,createClient:i,receiveToken:j}}),module.exports=d("remoteStorage")})()